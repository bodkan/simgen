<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>2&nbsp; Introduction to slendr – Simulation-Based Population Genomics and Inference in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-626149efe8f5d16e1d391ba177679bf0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./slendr.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to <em>slendr</em></span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Simulation-Based Population Genomics and Inference in R</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./slendr.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to <em>slendr</em></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#organization-of-the-exercises" id="toc-organization-of-the-exercises" class="nav-link active" data-scroll-target="#organization-of-the-exercises"><span class="header-section-number">3</span> Organization of the exercises</a></li>
  <li><a href="#programming-demographic-models-with-slendr" id="toc-programming-demographic-models-with-slendr" class="nav-link" data-scroll-target="#programming-demographic-models-with-slendr"><span class="header-section-number">4</span> Programming demographic models with <em>slendr</em></a>
  <ul class="collapse">
  <li><a href="#part-1-building-a-demographic-model-in-slendr" id="toc-part-1-building-a-demographic-model-in-slendr" class="nav-link" data-scroll-target="#part-1-building-a-demographic-model-in-slendr"><span class="header-section-number">4.0.1</span> Part 1: Building a demographic model in <em>slendr</em></a></li>
  <li><a href="#part-2-inspecting-the-model-visually" id="toc-part-2-inspecting-the-model-visually" class="nav-link" data-scroll-target="#part-2-inspecting-the-model-visually"><span class="header-section-number">4.0.2</span> Part 2: Inspecting the model visually</a></li>
  <li><a href="#part-3-simulating-genomic-data" id="toc-part-3-simulating-genomic-data" class="nav-link" data-scroll-target="#part-3-simulating-genomic-data"><span class="header-section-number">4.0.3</span> Part 3: Simulating genomic data</a></li>
  <li><a href="#part-4-inspecting-the-tree-sequence-object" id="toc-part-4-inspecting-the-tree-sequence-object" class="nav-link" data-scroll-target="#part-4-inspecting-the-tree-sequence-object"><span class="header-section-number">4.0.4</span> Part 4: Inspecting the tree-sequence object</a></li>
  <li><a href="#part-5-scheduling-sampling-events" id="toc-part-5-scheduling-sampling-events" class="nav-link" data-scroll-target="#part-5-scheduling-sampling-events"><span class="header-section-number">4.0.5</span> Part 5: Scheduling sampling events</a></li>
  <li><a href="#part-6-simulating-a-defined-set-of-individuals" id="toc-part-6-simulating-a-defined-set-of-individuals" class="nav-link" data-scroll-target="#part-6-simulating-a-defined-set-of-individuals"><span class="header-section-number">4.0.6</span> Part 6: Simulating a defined set of individuals</a></li>
  </ul></li>
  <li><a href="#computing-popgen-statistics-on-tree-sequences-from-slendr" id="toc-computing-popgen-statistics-on-tree-sequences-from-slendr" class="nav-link" data-scroll-target="#computing-popgen-statistics-on-tree-sequences-from-slendr"><span class="header-section-number">5</span> Computing popgen statistics on tree sequences from <em>slendr</em></a>
  <ul class="collapse">
  <li><a href="#part-1-computing-nucleotide-diversity" id="toc-part-1-computing-nucleotide-diversity" class="nav-link" data-scroll-target="#part-1-computing-nucleotide-diversity"><span class="header-section-number">5.1</span> Part 1: Computing nucleotide diversity</a></li>
  <li><a href="#part-2-computing-pairwise-divergence" id="toc-part-2-computing-pairwise-divergence" class="nav-link" data-scroll-target="#part-2-computing-pairwise-divergence"><span class="header-section-number">5.2</span> Part 2: Computing pairwise divergence</a></li>
  <li><a href="#part-3-detecting-neanderthal-admixture-in-europeans" id="toc-part-3-detecting-neanderthal-admixture-in-europeans" class="nav-link" data-scroll-target="#part-3-detecting-neanderthal-admixture-in-europeans"><span class="header-section-number">5.3</span> Part 3: Detecting Neanderthal admixture in Europeans</a></li>
  <li><a href="#part-4-detecting-neanderthal-admixture-in-europeans-v2.0" id="toc-part-4-detecting-neanderthal-admixture-in-europeans-v2.0" class="nav-link" data-scroll-target="#part-4-detecting-neanderthal-admixture-in-europeans-v2.0"><span class="header-section-number">5.4</span> Part 4: Detecting Neanderthal admixture in Europeans v2.0</a></li>
  </ul></li>
  <li><a href="#simulation-based-inference-of-n_e" id="toc-simulation-based-inference-of-n_e" class="nav-link" data-scroll-target="#simulation-based-inference-of-n_e"><span class="header-section-number">6</span> Simulation-based inference of <span class="math inline">\(N_e\)</span></a>
  <ul class="collapse">
  <li><a href="#part-1-a-self-contained-slendr-function-of-n_e-rightarrow-textrmafs" id="toc-part-1-a-self-contained-slendr-function-of-n_e-rightarrow-textrmafs" class="nav-link" data-scroll-target="#part-1-a-self-contained-slendr-function-of-n_e-rightarrow-textrmafs"><span class="header-section-number">6.1</span> Part 1: A self-contained <em>slendr</em> function of <span class="math inline">\(N_e \rightarrow \textrm{AFS}\)</span></a></li>
  <li><a href="#part-2-estimating-unknown-n_e-from-empirical-afs" id="toc-part-2-estimating-unknown-n_e-from-empirical-afs" class="nav-link" data-scroll-target="#part-2-estimating-unknown-n_e-from-empirical-afs"><span class="header-section-number">6.2</span> Part 2: Estimating unknown <span class="math inline">\(N_e\)</span> from empirical AFS</a></li>
  </ul></li>
  <li><a href="#simulating-and-detecting-natural-selection" id="toc-simulating-and-detecting-natural-selection" class="nav-link" data-scroll-target="#simulating-and-detecting-natural-selection"><span class="header-section-number">7</span> Simulating (and detecting) natural selection</a>
  <ul class="collapse">
  <li><a href="#part-1-simulating-a-tree-sequence-and-computing-tajimas-d" id="toc-part-1-simulating-a-tree-sequence-and-computing-tajimas-d" class="nav-link" data-scroll-target="#part-1-simulating-a-tree-sequence-and-computing-tajimas-d"><span class="header-section-number">7.0.1</span> Part 1: Simulating a tree sequence and computing Tajima’s D</a></li>
  <li><a href="#part-2-computing-tajimas-d-in-windows" id="toc-part-2-computing-tajimas-d-in-windows" class="nav-link" data-scroll-target="#part-2-computing-tajimas-d-in-windows"><span class="header-section-number">7.1</span> Part 2: Computing Tajima’s D in windows</a></li>
  <li><a href="#part-3-adding-positive-selection-to-the-base-demographic-model" id="toc-part-3-adding-positive-selection-to-the-base-demographic-model" class="nav-link" data-scroll-target="#part-3-adding-positive-selection-to-the-base-demographic-model"><span class="header-section-number">7.2</span> Part 3: Adding positive selection to the base demographic model</a></li>
  <li><a href="#part-4-running-a-selection-simulation-using-slim" id="toc-part-4-running-a-selection-simulation-using-slim" class="nav-link" data-scroll-target="#part-4-running-a-selection-simulation-using-slim"><span class="header-section-number">7.3</span> Part 4: Running a selection simulation using <code>slim()</code></a></li>
  <li><a href="#part-5-investigating-allele-frequency-trajectories" id="toc-part-5-investigating-allele-frequency-trajectories" class="nav-link" data-scroll-target="#part-5-investigating-allele-frequency-trajectories"><span class="header-section-number">7.4</span> Part 5: Investigating allele frequency trajectories</a></li>
  <li><a href="#part-6-tajimas-d-genome-wide-and-window-based-from-the-selection-model" id="toc-part-6-tajimas-d-genome-wide-and-window-based-from-the-selection-model" class="nav-link" data-scroll-target="#part-6-tajimas-d-genome-wide-and-window-based-from-the-selection-model"><span class="header-section-number">7.5</span> Part 6: Tajima’s D (genome-wide and window-based) from the selection model</a></li>
  </ul></li>
  <li><a href="#playing-around-with-pca-patterns" id="toc-playing-around-with-pca-patterns" class="nav-link" data-scroll-target="#playing-around-with-pca-patterns"><span class="header-section-number">8</span> Playing around with PCA patterns</a>
  <ul class="collapse">
  <li><a href="#part-1-create-a-model" id="toc-part-1-create-a-model" class="nav-link" data-scroll-target="#part-1-create-a-model"><span class="header-section-number">8.1</span> Part 1: Create a model</a></li>
  <li><a href="#part-2-simulate-a-mutated-tree-sequence" id="toc-part-2-simulate-a-mutated-tree-sequence" class="nav-link" data-scroll-target="#part-2-simulate-a-mutated-tree-sequence"><span class="header-section-number">8.2</span> Part 2: Simulate a (mutated!) tree sequence</a></li>
  <li><a href="#part-3-converting-a-tree-sequence-into-eigenstrat" id="toc-part-3-converting-a-tree-sequence-into-eigenstrat" class="nav-link" data-scroll-target="#part-3-converting-a-tree-sequence-into-eigenstrat"><span class="header-section-number">8.3</span> Part 3: Converting a tree sequence into EIGENSTRAT</a></li>
  <li><a href="#part-4-inspect-the-eigenstrat-data-produced-by-slendr" id="toc-part-4-inspect-the-eigenstrat-data-produced-by-slendr" class="nav-link" data-scroll-target="#part-4-inspect-the-eigenstrat-data-produced-by-slendr"><span class="header-section-number">8.4</span> Part 4: Inspect the EIGENSTRAT data produced by <em>slendr</em></a></li>
  <li><a href="#part-5-principal-component-analysis-on-the-entire-simulated-data-set" id="toc-part-5-principal-component-analysis-on-the-entire-simulated-data-set" class="nav-link" data-scroll-target="#part-5-principal-component-analysis-on-the-entire-simulated-data-set"><span class="header-section-number">8.5</span> Part 5: Principal Component Analysis on the entire simulated data set</a></li>
  </ul></li>
  <li><a href="#spatial-pca" id="toc-spatial-pca" class="nav-link" data-scroll-target="#spatial-pca"><span class="header-section-number">9</span> Spatial PCA</a>
  <ul class="collapse">
  <li><a href="#per-population-ne-values" id="toc-per-population-ne-values" class="nav-link" data-scroll-target="#per-population-ne-values"><span class="header-section-number">9.0.1</span> Per-population Ne values</a></li>
  </ul></li>
  <li><a href="#ancestry-tracts-and-chromosome-painintg" id="toc-ancestry-tracts-and-chromosome-painintg" class="nav-link" data-scroll-target="#ancestry-tracts-and-chromosome-painintg"><span class="header-section-number">10</span> Ancestry tracts and chromosome painintg</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to <em>slendr</em></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- TODO: Looks at these links to define a custom "Show the solution" callout -->
<!-- https://www.youtube.com/watch?v=DDQO_3R-q74 -->
<!-- https://examples.quarto.pub/collapse-callout/ -->
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Setup on your own computer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><strong>If you want to set up everything on your local machine from scratch (maybe after the course is over and you want to return to the material on yor own), just follow the couple of steps right below.</strong></p>
<ol type="1">
<li><p><strong>Clone the repository with the activity materials</strong>. In a shell terminal on Linux or macOS, in your home directory (or anywhere else, really) you can run:</p>
<pre><code>$ git clone https://github.com/bodkan/simgen ~/simgen</code></pre></li>
</ol>
<p>(For Windows users: You can download a zip file with the whole course even without git.)</p>
<ol start="2" type="1">
<li><p><strong>Open RStudio and install all of the following dependencies:</strong></p>
<pre><code>&gt; install.packages(c("slendr", "combinat", "cowplot", "dplyr", "readr",
                     "tidyr", "ggplot2", "rmarkdown", "yaml"))</code></pre></li>
<li><p><strong>Set up the Python environment used by the <em>slendr</em> R package</strong> for simulation and tree-sequence analysis (still in the R console!):</p>
<pre><code>&gt; slendr::setup_env(agree = TRUE)</code></pre>
<p>If everything worked, you should get an optimistic message saying:</p>
<pre><code>======================================================================
Python environment for slendr has been successfuly created, and the R
interface to msprime, tskit, and pyslim modules has been activated.

In future sessions, activate this environment by calling init_env().
=======================================================================</code></pre></li>
<li><p><strong>Open your RStudio (unless you did the above steps already in RStudio)</strong>, and you’re good to go!</p></li>
</ol>
<hr>
<p><strong>If the <code>setup_env()</code> installation procedure fails, try the following:</strong></p>
<ol type="1">
<li>Delete the failed installation attempt:</li>
</ol>
<pre><code>slendr::clear_env(force = TRUE, all = TRUE)</code></pre>
<ol start="2" type="1">
<li>Try installing it again, this time using <code>pip</code> as a Python installation method (the default is <code>conda</code> which unfortunately fails fairly often):</li>
</ol>
<pre><code>slendr::setup_env(agree = TRUE, pip = TRUE)</code></pre>
<p>In every previous installments of this workshop, this is all that was needed to resolve problems.*</p>
<hr>
<p><strong>Installing SLiM</strong></p>
<p>It’s unclear whether we will manage to go through the entirety of the selection-based exercise. However, to be able to do this, having SLiM at least version 4.2 (and it being available in your unix <code>$PATH!</code>) is required. If this isn’t possible for your, don’t worry. You’ll be able to do most of that exercise even without SLiM by using cached results of the SLiM simulation that I provided.</p>
</div>
</div>
</div>
<section id="organization-of-the-exercises" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Organization of the exercises</h1>
<p>For each exercise, you will get a brief explanation of the problem at hand and some information about functions that could be useful to solve the exercise. <strong>The concrete, specific task will be always written like this in bold. As you work on each part of each exercises, look for these bold lines.</strong></p>
<p><strong>Your goal for each exercise is to write a complete R script script (in RStudio <code>File -&gt; New file -&gt; R script</code>). I suggest you save the script for each exercise as <code>exercise1.R</code>, <code>exercise2.R</code>, etc., just to keep things tidy and easy to troubleshoot if needed.</strong></p>
<p><strong>Each exercise is composed of individual <em>parts</em>, which are designed to build one upon the other in the order they are specified. As you progress through sequential parts of each exercise, you will be adding code to your script for that exercise.</strong></p>
<section id="dont-worry-about-the-number-of-exercises-youre-supposed-to-do" class="level4" data-number="3.0.0.1">
<h4 data-number="3.0.0.1" class="anchored" data-anchor-id="dont-worry-about-the-number-of-exercises-youre-supposed-to-do"><span class="header-section-number">3.0.0.1</span> Don’t worry about the number of exercises you’re <em>“supposed to do”</em></h4>
<p>How far we manage to crunch through the content of this session will depend on everybody’s level of confidence in programming <em>and</em> population genetics. The contents of the activities as a whole are designed so that no matter the moment at which we run out of time, you will take home enough knowledge of <em>slendr</em> to be able to immediately apply it to your own projects.</p>
<p><strong>To avoid anyone getting overwhelmed, I’ll be stopping the activity at some “checkpoints”, to check in with how everything is going and quickly go through the example solutions for the parts until that point, and give a quick explanation.</strong></p>
<p>If you find yourself way ahead, there are bonus exercises (which I will not be going through with everyone) – those should provide at entertainment and a bit more challenge for you while the rest of us are catching up. If you’re <em>really</em> far ahead, just continue to the next exercise without waiting for the rest of us.</p>
</section>
<section id="note-on-the-programming-aspect-of-the-exercises" class="level4" data-number="3.0.0.2">
<h4 data-number="3.0.0.2" class="anchored" data-anchor-id="note-on-the-programming-aspect-of-the-exercises"><span class="header-section-number">3.0.0.2</span> Note on the programming aspect of the exercises</h4>
<p>All the exercises will involve “real coding”! If you’ve never really programmed entire scripts before, this could feel a little intimidating. Don’t worry. If you’re ever lost, just take a peek at the solutions which are (by default hidden) under each exercise part. Always try to work on a solution on your own, but never let this be a barrier to your progress. Feel free to copy-paste bits of my solutions into your own scripts.</p>
<p>If you find yourself <a href="https://scryfall.com/card/gtc/54/totally-lost"><em>totally lost</em></a>, don’t hesitate to read my solutions from the get go, copy-pasting them into your own script in the RStudio, executing them line by line, and trying to understand what’s going on. <strong>It’s the understanding that we’re after here. Whether or not you can implement everything yourself from scratch does not actually matter at all.</strong> (Nobody in history has learned to program from scratch. Everyone started by copy-pasting code examples written by someone else. So feel free to do the same!)</p>
</section>
</section>
<section id="programming-demographic-models-with-slendr" class="level1 page-columns page-full" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Programming demographic models with <em>slendr</em></h1>
<section id="part-1-building-a-demographic-model-in-slendr" class="level3 page-columns page-full" data-number="4.0.1">
<h3 data-number="4.0.1" class="anchored" data-anchor-id="part-1-building-a-demographic-model-in-slendr"><span class="header-section-number">4.0.1</span> Part 1: Building a demographic model in <em>slendr</em></h3>
<p><strong>Use functions such as <code>population()</code>, <code>gene_flow()</code>, and <code>compile_model()</code>, which we discussed in the “crash course” at the start of this session, to program the following toy model of human demographic history in <em>slendr</em>.</strong> (Apologies for my bad handwriting and poor artistic ability.)</p>
<p><img src="images/intro_model1.png" class="img-fluid" style="width:50.0%"></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> You could easily program the model so that different ancestral populations are represented by separate <code>population()</code> commands (i.e., your model would start with a population called “human_chimp_ancestor” from which a “CHIMP” and “hominin_ancestor” populations would split at 6 Mya, etc.) but generally this is too annoying to do and requires too much code.</p>
<p>Feel free to write the model so that “CHIMP” is the first population, then “AFR” population splits from it at 6 Mya, etc… Although it probably isn’t the most accurate way to describe the real evolutionary history, it simplifies the coding significantly.</p>
<p><br> [Mya = million years ago; kya = thousand years ago]</p>
</div></div><p><strong>Hint:</strong> Create a new script <code>exercise1.R</code> in your RStudio session using the following “template”. Then add a sequence of appropriate <code>population()</code> calls using the syntax from the introductory slides (using the <code>parent = &lt;pop&gt;</code> argument for programming splits of daughter populations – which will be all except the CHIMP lineage in our example), etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slendr)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">init_env</span>()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;replace this with `population()` definitions like in the slides&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;replace this with your gene-flow definition in variable `gf`&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">compile_model</span>(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">populations =</span> <span class="fu">list</span>(...), <span class="co"># &lt;put your list of populations here&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">gene_flow =</span> gf,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">generation_time =</span> <span class="dv">30</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> With <em>slendr</em> you can specify time in whatever format is more convenient or readable for your model. For instance here, because we’re dealing with historical events which are commonly expressed in times given as”years ago”, we can write them in a decreasing order – i.e.&nbsp;7Mya → 6Mya → …, as shown above – or, in terms of R code, 7e6 (or 7000000), 6e6 (6000000), etc.</p>
<p>In a later example, you will see that you can also encode the events in the time direction going “forward” (i.e., the first event starting in generation 1, a following event in generation 42, and so on).</p>
</div></div><p><strong>Hint:</strong> Remember that <em>slendr</em> is designed with interactivity in mind! When you write a chunk of code (such as a command to create a population through a population split, or model compilation to create a <code>model</code> object), execute that bit of code in the R console and inspect the summary information printed by evaluating the respective R object you just created. You can either copy-pasted stuff from your script to the R console, or use a convenient RStudio shortcut like Ctrl+Enter (Linux and Windows), or Cmd+Enter (Mac).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slendr)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">init_env</span>()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="do">## The interface to all required Python modules has been activated.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Chimpanzee outgroup</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>chimp <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"CHIMP"</span>, <span class="at">time =</span> <span class="fl">7e6</span>, <span class="at">N =</span> <span class="dv">5000</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Two populations of anatomically modern humans: Africans and Europeans</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>afr <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"AFR"</span>, <span class="at">parent =</span> chimp, <span class="at">time =</span> <span class="fl">6e6</span>, <span class="at">N =</span> <span class="dv">15000</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>eur <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"EUR"</span>, <span class="at">parent =</span> afr, <span class="at">time =</span> <span class="fl">70e3</span>, <span class="at">N =</span> <span class="dv">3000</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Neanderthal population splitting at 600 ky ago from modern humans</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co"># (becomes extinct by 40 ky ago)</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>nea <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"NEA"</span>, <span class="at">parent =</span> afr, <span class="at">time =</span> <span class="fl">600e3</span>, <span class="at">N =</span> <span class="dv">1000</span>, <span class="at">remove =</span> <span class="fl">40e3</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Neanderthal introgression event (3% admixture between 55-50 kya)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>gf <span class="ot">&lt;-</span> <span class="fu">gene_flow</span>(<span class="at">from =</span> nea, <span class="at">to =</span> eur, <span class="at">rate =</span> <span class="fl">0.03</span>, <span class="at">start =</span> <span class="dv">55000</span>, <span class="at">end =</span> <span class="dv">50000</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the entire model into a single slendr R object</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">compile_model</span>(</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">populations =</span> <span class="fu">list</span>(chimp, nea, afr, eur),</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">gene_flow =</span> gf,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">generation_time =</span> <span class="dv">30</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/introgression"</span>),  <span class="co"># &lt;--- don't worry about these two</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span>, <span class="at">force =</span> <span class="cn">TRUE</span>            <span class="co"># &lt;--- lines of code (ask me if interested)</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="part-2-inspecting-the-model-visually" class="level3 page-columns page-full" data-number="4.0.2">
<h3 data-number="4.0.2" class="anchored" data-anchor-id="part-2-inspecting-the-model-visually"><span class="header-section-number">4.0.2</span> Part 2: Inspecting the model visually</h3>
<p>To visualize a <em>slendr</em> model, you use the function <code>plot_model()</code>. <strong>Plot your compiled <code>model</code> to make sure you programmed it correctly!</strong> Your figure should roughly correspond to my doodle above.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> Plotting of models in <em>slendr</em> can be sometimes a little wonky, especially if many things are happening at once. When plotting your model, experiment with arguments <code>log = TRUE</code>, <code>proportions = TRUE</code>, <code>gene_flow = TRUE</code>. Check <code>?plot_model</code> for more information on these.</p>
</div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model, <span class="at">sizes =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model, <span class="at">sizes =</span> <span class="cn">FALSE</span>, <span class="at">log =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-4-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model, <span class="at">log =</span> <span class="cn">TRUE</span>, <span class="at">proportions =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-4-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="part-3-simulating-genomic-data" class="level3 page-columns page-full" data-number="4.0.3">
<h3 data-number="4.0.3" class="anchored" data-anchor-id="part-3-simulating-genomic-data"><span class="header-section-number">4.0.3</span> Part 3: Simulating genomic data</h3>
<p>Once you have a compiled <em>slendr</em> model stored in an R variable (from now on, <code>model</code> will always mean a variable containing a compiled <em>slendr</em> model object relevant for the given exercise, for simplicity), we can simulate data from it. By default, <em>slendr</em> models always produce a <a href="https://tskit.dev/tutorials/what_is.html">tree sequence</a>.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> Tree sequence provides an extremely efficient means to store and work with genomic data at a massive scale. However, you can always get simulated data even in <a href="https://www.slendr.net/reference/index.html#tree-sequence-format-conversion">traditional file formats</a>, such as VCF, EIGENSTRAT, or a plain old table of ancestral/derived genotypes.</p>
<p>In this activity we will be only working with tree sequences, because it’s much easier and faster to get interesting statistics from it directly in R.</p>
</div></div><p>There are two simulation engines built into <em>slendr</em> implemented by functions <code>msprime()</code> and <code>slim()</code>. For traditional, non-spatial, neutral demographic models, the engine provided by the <code>msprime()</code> function is much more efficient, so we’ll be using that for the time being. However, from a popgen theoretical perspective, both simulation functions will give you the same results for any given compiled <em>slendr</em> model (up to some level of stochastic noise, of course).</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> Yes, this means you don’t have to write any <em>msprime</em> (or SLiM) code to simulate data from a <em>slendr</em> model!</p>
</div></div><p>Here’s how you can use the function to simulate a tree sequence from the model you’ve just created using <code>compile_model()</code> in your script:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  model,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">sequence_length =</span> <span class="sc">&lt;</span>length of sequence to simulate [as bp]<span class="sc">&gt;</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">recombination_rate =</span> <span class="sc">&lt;</span>uniform recombination rate [per bp per generation]<span class="sc">&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You will be seeing this kind of pattern over and over again in this exercise, so it’s a good idea to keep it in mind.</p>
<p><strong>Hint:</strong> The <code>msprime()</code> function has also arguments <code>debug</code> and <code>run</code> which can be extremely useful for debugging.</p>
<p><strong>Simulate a tree sequence from your compiled <code>model</code> using the <code>msprime()</code> engine, storing it to a variable <code>ts</code> as shown right above. Use <code>sequence_length = 1e6</code> (so 1 Mb of sequence) and <code>recombination_rate = 1e-8</code> (crossover events per base pair per generation). Then experiment with setting <code>debug = TRUE</code> (this prints out <em>msprime</em>’s own debugging summary which you might already be familiar with from your previous activity?) and then <code>run = FALSE</code> (this prints out a raw command-line which can run a <em>slendr</em> simulation in the shell).</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This simulates a tskit tree sequence from a slendr model. Note that you didn't have</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to write any msprime or tskit Python code!</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> <span class="fl">1e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting `debug = TRUE` instructs slendr's built-in msprime script to print</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># out msprime's own debugger information. This can be very useful for debugging,</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># in addition to the visualization of the model as shown above.</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> <span class="fl">1e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>, <span class="at">debug =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="do">## DemographyDebugger</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠═════════════════════════════════════╗</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="do">## ║ Epoch[0]: [0, 1.67e+03) generations ║</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠═════════════════════════════════════╝</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Populations (total=4 active=4)</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌─────────────────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │     start│       end│growth_rate  │ CHIMP │ AFR │ NEA │ EUR │</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├─────────────────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  CHIMP│    5000.0│    5000.0│ 0           │   0   │  0  │  0  │  0  │</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    AFR│   15000.0│   15000.0│ 0           │   0   │  0  │  0  │  0  │</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    NEA│    1000.0│    1000.0│ 0           │   0   │  0  │  0  │  0  │</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    EUR│    3000.0│    3000.0│ 0           │   0   │  0  │  0  │  0  │</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └─────────────────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Events @ generation 1.67e+03</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌─────────────────────────────────────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  time│type            │parameters              │effect                                  │</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├─────────────────────────────────────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  1666│Migration rate  │source=EUR, dest=NEA,   │Backwards-time migration rate from EUR  │</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │      │change          │rate=0.000179640718562  │to NEA → 0.00017964071856287425         │</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │      │                │87425                   │                                        │</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └─────────────────────────────────────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠════════════════════════════════════════════╗</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="do">## ║ Epoch[1]: [1.67e+03, 1.83e+03) generations ║</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠════════════════════════════════════════════╝</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Populations (total=4 active=4)</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌───────────────────────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │     start│       end│growth_rate  │ CHIMP │ AFR │    NEA    │ EUR │</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├───────────────────────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  CHIMP│    5000.0│    5000.0│ 0           │   0   │  0  │     0     │  0  │</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    AFR│   15000.0│   15000.0│ 0           │   0   │  0  │     0     │  0  │</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    NEA│    1000.0│    1000.0│ 0           │   0   │  0  │     0     │  0  │</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    EUR│    3000.0│    3000.0│ 0           │   0   │  0  │ 0.0001796 │  0  │</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └───────────────────────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Events @ generation 1.83e+03</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌────────────────────────────────────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  time│type            │parameters             │effect                                  │</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├────────────────────────────────────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  1833│Migration rate  │source=EUR, dest=NEA,  │Backwards-time migration rate from EUR  │</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │      │change          │rate=0                 │to NEA → 0                              │</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈│</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  1833│Census          │                       │Insert census nodes to record the       │</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │      │                │                       │location of all lineages                │</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └────────────────────────────────────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠════════════════════════════════════════════╗</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a><span class="do">## ║ Epoch[2]: [1.83e+03, 2.33e+03) generations ║</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠════════════════════════════════════════════╝</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Populations (total=4 active=4)</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌─────────────────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │     start│       end│growth_rate  │ CHIMP │ AFR │ NEA │ EUR │</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├─────────────────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  CHIMP│    5000.0│    5000.0│ 0           │   0   │  0  │  0  │  0  │</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    AFR│   15000.0│   15000.0│ 0           │   0   │  0  │  0  │  0  │</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    NEA│    1000.0│    1000.0│ 0           │   0   │  0  │  0  │  0  │</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    EUR│    3000.0│    3000.0│ 0           │   0   │  0  │  0  │  0  │</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └─────────────────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Events @ generation 2.33e+03</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌───────────────────────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  time│type        │parameters      │effect                                │</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├───────────────────────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  2333│Population  │derived=[EUR],  │Moves all lineages from the 'EUR'     │</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │      │Split       │ancestral=AFR   │derived population to the ancestral   │</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │      │            │                │'AFR' population. Also set 'EUR' to   │</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │      │            │                │inactive, and all migration rates to  │</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │      │            │                │and from the derived population to    │</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │      │            │                │zero.                                 │</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └───────────────────────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠═════════════════════════════════════════╗</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="do">## ║ Epoch[3]: [2.33e+03, 2e+04) generations ║</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠═════════════════════════════════════════╝</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Populations (total=4 active=3)</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌───────────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │     start│       end│growth_rate  │ CHIMP │ AFR │ NEA │</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├───────────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  CHIMP│    5000.0│    5000.0│ 0           │   0   │  0  │  0  │</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    AFR│   15000.0│   15000.0│ 0           │   0   │  0  │  0  │</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    NEA│    1000.0│    1000.0│ 0           │   0   │  0  │  0  │</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └───────────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Events @ generation 2e+04</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌────────────────────────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │   time│type        │parameters      │effect                                │</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├────────────────────────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  2e+04│Population  │derived=[NEA],  │Moves all lineages from the 'NEA'     │</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │Split       │ancestral=AFR   │derived population to the ancestral   │</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │            │                │'AFR' population. Also set 'NEA' to   │</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │            │                │inactive, and all migration rates to  │</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │            │                │and from the derived population to    │</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │            │                │zero.                                 │</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └────────────────────────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠══════════════════════════════════════╗</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a><span class="do">## ║ Epoch[4]: [2e+04, 2e+05) generations ║</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠══════════════════════════════════════╝</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Populations (total=4 active=2)</span></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌─────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │     start│       end│growth_rate  │ CHIMP │ AFR │</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├─────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  CHIMP│    5000.0│    5000.0│ 0           │   0   │  0  │</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │    AFR│   15000.0│   15000.0│ 0           │   0   │  0  │</span></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └─────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Events @ generation 2e+05</span></span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌──────────────────────────────────────────────────────────────────────────────┐</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │   time│type        │parameters       │effect                                 │</span></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├──────────────────────────────────────────────────────────────────────────────┤</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  2e+05│Population  │derived=[AFR],   │Moves all lineages from the 'AFR'      │</span></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │Split       │ancestral=CHIMP  │derived population to the ancestral    │</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │            │                 │'CHIMP' population. Also set 'AFR' to  │</span></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │            │                 │inactive, and all migration rates to   │</span></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │            │                 │and from the derived population to     │</span></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │            │                 │zero.                                  │</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └──────────────────────────────────────────────────────────────────────────────┘</span></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠════════════════════════════════════╗</span></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a><span class="do">## ║ Epoch[5]: [2e+05, inf) generations ║</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a><span class="do">## ╠════════════════════════════════════╝</span></span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a><span class="do">## ╟    Populations (total=4 active=1)</span></span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ┌─────────────────────────────────────────┐</span></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │       │    start│      end│growth_rate  │</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    ├─────────────────────────────────────────┤</span></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    │  CHIMP│   5000.0│   5000.0│ 0           │</span></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a><span class="do">## ║    └─────────────────────────────────────────┘</span></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a><span class="co"># For debugging of technical issues (with msprime, with slendr, or both), it is</span></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a><span class="co"># very useful to have the `msprime` function dump the "raw" command-line to</span></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a><span class="co"># run the simulation on the terminal using plain Python interpreter</span></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a><span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> <span class="fl">1e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>, <span class="at">run =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a><span class="do">## /Users/mp/Library/r-miniconda-arm64/envs/Python-3.12_msprime-1.3.3_tskit-0.5.8_pyslim-1.0.4_tspop-0.0.2/bin/python /Users/mp/Projects/simgen/data/introgression/script.py --seed 342191428 --model /Users/mp/Projects/simgen/data/introgression --sequence-length 1000000 --recombination-rate 1e-08    --path &lt;path to a .trees file&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="part-4-inspecting-the-tree-sequence-object" class="level3 page-columns page-full" data-number="4.0.4">
<h3 data-number="4.0.4" class="anchored" data-anchor-id="part-4-inspecting-the-tree-sequence-object"><span class="header-section-number">4.0.4</span> Part 4: Inspecting the tree-sequence object</h3>
<p>As we will see later, <em>slendr</em> provides an R-friendly interface to accessing a <a href="https://tskit.dev/tskit/docs/stable/python-api.html">subset of <em>tskit</em>’s functionality</a> for working with tree sequences and for computing various popgen statistics.</p>
<p>For now, <strong>type out the <code>ts</code> object in the terminal – what do you see?</strong> You should get a summary of a tree-sequence object that you’re familiar with from your <em>msprime</em> and <em>tskit</em> activity earlier in the day.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> This is a very important feature of <em>slendr</em> – when a simulation is concluded (doesn’t matter if it was a <code>slim()</code> or <code>msprime()</code> simulation), you will get a normal <em>tskit</em> object. In fact, the fact that <em>slendr</em> supports (so far, and likely always) only a “subset” of all of <em>tskit</em>’s functionality isn’t stopping you to write custom Python/<em>tskit</em> processing code of a tree sequence generated from a <em>slendr</em> model. Under the hood, a <em>slendr</em> simulation <em>really is</em> just an <em>msprime</em> (or SLiM) simulation! It’s just executed through a simplified interface.</p>
</div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Typing out the object with the result shows that it's a good old tskit</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tree-sequence object</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>ts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>╔═══════════════════════════╗
║TreeSequence               ║
╠═══════════════╤═══════════╣
║Trees          │       9665║
╟───────────────┼───────────╢
║Sequence Length│    1000000║
╟───────────────┼───────────╢
║Time Units     │generations║
╟───────────────┼───────────╢
║Sample Nodes   │      48000║
╟───────────────┼───────────╢
║Total Size     │    8.8 MiB║
╚═══════════════╧═══════════╝
╔═══════════╤══════╤═════════╤════════════╗
║Table      │Rows  │Size     │Has Metadata║
╠═══════════╪══════╪═════════╪════════════╣
║Edges      │134467│  4.1 MiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Individuals│ 24000│656.3 KiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Migrations │     0│  8 Bytes│          No║
╟───────────┼──────┼─────────┼────────────╢
║Mutations  │     0│ 16 Bytes│          No║
╟───────────┼──────┼─────────┼────────────╢
║Nodes      │104935│  2.8 MiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Populations│     4│341 Bytes│         Yes║
╟───────────┼──────┼─────────┼────────────╢
║Provenances│     1│  2.7 KiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Sites      │     0│ 16 Bytes│          No║
╚═══════════╧══════╧═════════╧════════════╝</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>The brilliance of the tree-sequence data structure rests on its elegant table-based implementation (much more information on that is <a href="https://tskit.dev/tskit/docs/stable/data-model.html">here</a>). <em>slendr</em> isn’t really designed to run very complex low-level manipulations of tree-sequence data (its strength lies in the convenient interface to popgen statistical functions implemented by <em>tskit</em>), but it does contain a couple of functions which can be useful for inspecting the lower-level nature of a tree sequence. Let’s look at a couple of them now.</p>
<p><strong>Use the <code>ts_table</code> function to inspect the low-level table-based representation of a tree sequence.</strong> For instance, you can get the table of nodes with <code>ts_table(ts, "nodes")</code>, edges with <code>ts_table(ts, "edges")</code>, and do the same thing for “individuals”, “mutations”, and “sites”. <strong>Does your tree sequence contain any mutations? If not, why, and how can we even do any popgen with data without any mutations? As you’re doing this, take a look at at the <a href="https://tskit.dev/tutorials/_images/0327585c23c21d289094cc6394cc71ecc7e43f14197d7961b9d759c5abcc0e29.svg">following figure</a> (this was made from a different tree sequence than you have, but that’s OK) to help you relate the information in the tables to a tree sequence which those tables (particularly tables of nodes and edges) implicitly encode.</strong></p>
<p>This should convince you that the final product of a <em>slendr</em> simulation really is the same kind of tree-sequence object that you learned about in the previous activities today. You don’t have to study these tables in detail!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># slendr provides a helper function which allows access to all the low-level</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># components of every tree-sequence object</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_table</span>(ts, <span class="st">"nodes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 104,935 × 5
   node_id    ind_id pop_id  time time_tskit
     &lt;int&gt; &lt;int[1d]&gt;  &lt;int&gt; &lt;dbl&gt;      &lt;dbl&gt;
 1       0         0      0     0          0
 2       1         0      0     0          0
 3       2         1      0     0          0
 4       3         1      0     0          0
 5       4         2      0     0          0
 6       5         2      0     0          0
 7       6         3      0     0          0
 8       7         3      0     0          0
 9       8         4      0     0          0
10       9         4      0     0          0
# ℹ 104,925 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_table</span>(ts, <span class="st">"edges"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 134,467 × 5
      id child parent  left   right
   &lt;dbl&gt; &lt;int&gt;  &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1     0  2491  48000     0 1000000
 2     1  2659  48000     0 1000000
 3     2 15910  48001     0 1000000
 4     3 36107  48001     0 1000000
 5     4 42212  48002     0 1000000
 6     5 46429  48002     0 1000000
 7     6 20680  48003     0 1000000
 8     7 30034  48003     0 1000000
 9     8 31521  48004     0 1000000
10     9 39024  48004     0 1000000
# ℹ 134,457 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_table</span>(ts, <span class="st">"individuals"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24,000 × 5
   ind_id  time    pop_id time_tskit sampled
    &lt;dbl&gt; &lt;dbl&gt; &lt;int[1d]&gt;  &lt;dbl[1d]&gt; &lt;lgl&gt;  
 1      0     0         0          0 TRUE   
 2      1     0         0          0 TRUE   
 3      2     0         0          0 TRUE   
 4      3     0         0          0 TRUE   
 5      4     0         0          0 TRUE   
 6      5     0         0          0 TRUE   
 7      6     0         0          0 TRUE   
 8      7     0         0          0 TRUE   
 9      8     0         0          0 TRUE   
10      9     0         0          0 TRUE   
# ℹ 23,990 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We didn't simulate any mutations, so we only have genealogies for now.</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_table</span>(ts, <span class="st">"mutations"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 5
# ℹ 5 variables: id &lt;dbl&gt;, site &lt;int&gt;, node &lt;int&gt;, time &lt;dbl&gt;, time_tskit &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_table</span>(ts, <span class="st">"sites"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 2
# ℹ 2 variables: id &lt;dbl&gt;, position &lt;dbl&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>There are also two <em>slendr</em>-specific functions called <code>ts_samples()</code> (which retrieves the “symbolic names” and dates of all recorded individuals at the end of a simulation) and <code>ts_nodes()</code>. <strong>You can run them simply as <code>ts_samples(ts)</code> and <code>ts_nodes(ts)</code>. How many individuals (samples) are in your tree sequence as you simulated it? How is the result of <code>ts_nodes()</code> different from <code>ts_samples()</code>?</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># slendr provides a convenient function `ts_samples()` which allows us to</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect the contents of a simulated tree sequence in a more human-readable,</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># simplified way. We can see that our tree sequence contains a massive number</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># of individuals. Too many, in fact -- we recorded every single individual alive</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># at the end of our simulation, which is something we're unlikely to be ever lucky</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># enough to have, regardless of which species we study.</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24,000 × 3
   name    time pop  
   &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;
 1 AFR_1      0 AFR  
 2 AFR_2      0 AFR  
 3 AFR_3      0 AFR  
 4 AFR_4      0 AFR  
 5 AFR_5      0 AFR  
 6 AFR_6      0 AFR  
 7 AFR_7      0 AFR  
 8 AFR_8      0 AFR  
 9 AFR_9      0 AFR  
10 AFR_10     0 AFR  
# ℹ 23,990 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(pop) <span class="sc">%&gt;%</span> tally</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  pop       n
  &lt;chr&gt; &lt;int&gt;
1 AFR   15000
2 CHIMP  5000
3 EUR    3000
4 NEA    1000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This function returns a table similar to the one produced by `ts_table(ts, "nodes")`</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># above, except that it contains additional slendr metadata (names of individuals</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># belonging to each node, spatial coordinates of nodes for spatial models, etc.).</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># It's a bit more useful for analyzing tree-sequence data than the "low-level" functions.</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_nodes</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  name  pop   ind_id node_id  time time_tskit sampled pop_id
  &lt;chr&gt; &lt;fct&gt;  &lt;dbl&gt;   &lt;int&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;lgl&gt;    &lt;int&gt;
1 AFR_1 AFR     5000   10000     0          0 TRUE         1
2 AFR_1 AFR     5000   10001     0          0 TRUE         1
3 AFR_2 AFR     5001   10002     0          0 TRUE         1
4 AFR_2 AFR     5001   10003     0          0 TRUE         1
5 AFR_3 AFR     5002   10004     0          0 TRUE         1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_nodes</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">tail</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  name  pop   ind_id node_id     time time_tskit sampled pop_id
  &lt;chr&gt; &lt;fct&gt;  &lt;dbl&gt;   &lt;int&gt;    &lt;dbl&gt;      &lt;dbl&gt; &lt;lgl&gt;    &lt;int&gt;
1 &lt;NA&gt;  CHIMP     NA  104930 7460638.    248688. FALSE        0
2 &lt;NA&gt;  CHIMP     NA  104931 7477971.    249266. FALSE        0
3 &lt;NA&gt;  CHIMP     NA  104932 7510435.    250348. FALSE        0
4 &lt;NA&gt;  CHIMP     NA  104933 7576142.    252538. FALSE        0
5 &lt;NA&gt;  CHIMP     NA  104934 7874508.    262484. FALSE        0</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="part-5-scheduling-sampling-events" class="level3 page-columns page-full" data-number="4.0.5">
<h3 data-number="4.0.5" class="anchored" data-anchor-id="part-5-scheduling-sampling-events"><span class="header-section-number">4.0.5</span> Part 5: Scheduling sampling events</h3>
<p>In the table produced by the <code>ts_samples()</code> function you saw that the tree sequence we simulated recorded <em>everyone</em>. It’s very unlikely, unless we’re extremely lucky, that we’ll ever have a sequence of every single individual in a population that we study. To get a little closer to the scale of the genomic data that we usually work with on a day-to-day basis, we can restrict our simulation to only record a subset of individuals.</p>
<p>We can precisely define which individuals (from which populations, and at which times) should be recorded in a tree sequence using the <em>slendr</em> function <code>schedule_sampling()</code>. For instance, if we have a <code>model</code> with some <em>slendr</em> populations in variables <code>eur</code> and <code>afr</code>, we can schedule the recording of 5 individuals from each at times 10000 (years ago) and 0 (present-day) (using the “years before present” direction of time in our current model of Neanderthal introgression) with the following code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>pop_schedule <span class="ot">&lt;-</span> <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">10000</span>, <span class="dv">0</span>), <span class="fu">list</span>(eur, <span class="dv">5</span>), <span class="fu">list</span>(afr, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function simply returns a data frame. As such, we can create multiple of such schedules (of arbitrary complexity and granularity), and then bind them together into a single sampling schedule with a single line of code, like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the `times =` argument of the `schedule_sampling()` function can be</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co"># a vector of times like here...</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>ancient_times <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">40000</span>, <span class="dv">30000</span>, <span class="dv">20000</span>, <span class="dv">10000</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>eur_samples <span class="ot">&lt;-</span> <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> ancient_times, <span class="fu">list</span>(eur, <span class="dv">1</span>))</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ... but also just a single number like here</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>afr_samples <span class="ot">&lt;-</span> <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="dv">0</span>, <span class="fu">list</span>(afr, <span class="dv">1</span>))</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>nea_samples <span class="ot">&lt;-</span> <span class="fu">schedule_sampling</span>(model, <span class="at">time =</span> <span class="dv">60000</span>, <span class="fu">list</span>(nea, <span class="dv">1</span>))</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co"># But whatever the means you create the individual sampling schedules with,</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co"># you can always bind them all to a single table with the `rbind()` function</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>schedule <span class="ot">&lt;-</span> <span class="fu">rbind</span>(eur_samples, afr_samples, nea_samples)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>schedule</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Using the function <code>schedule_sampling</code> (and with the help of <code>rbind</code> as shown in the previous code chunk), program the sampling of the following sample sets at given times, saving it to variable called <code>schedule</code>:</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>time</th>
<th style="text-align: left;">population</th>
<th># individuals</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>70000</td>
<td style="text-align: left;">nea</td>
<td>1</td>
</tr>
<tr class="even">
<td>40000</td>
<td style="text-align: left;">nea</td>
<td>1</td>
</tr>
<tr class="odd">
<td>0</td>
<td style="text-align: left;">chimp</td>
<td>1</td>
</tr>
<tr class="even">
<td>0</td>
<td style="text-align: left;">afr</td>
<td>5</td>
</tr>
<tr class="odd">
<td>0</td>
<td style="text-align: left;">eur</td>
<td>10</td>
</tr>
</tbody>
</table>
<p><strong>Additionally, schedule the sampling of a single <code>eur</code> individual at the following times:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">40000</span>, <span class="dv">2000</span>, <span class="at">by =</span> <span class="sc">-</span><span class="dv">2000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> You can provide a vector variable (such as <code>t</code> in this example) as the <code>times =</code> argument of <code>schedule_sampling()</code>.</p>
</div></div><p><strong>In total, you should schedule the recording of 38 individuals.</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we scheduled the sampling of two Neanderthals at 70kya and 40kya</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>nea_samples <span class="ot">&lt;-</span> <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">70000</span>, <span class="dv">40000</span>), <span class="fu">list</span>(nea, <span class="dv">1</span>))</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>nea_samples <span class="co"># (this function produces a plain old data frame!)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
   time pop       n y_orig x_orig y     x    
  &lt;int&gt; &lt;chr&gt; &lt;int&gt; &lt;lgl&gt;  &lt;lgl&gt;  &lt;lgl&gt; &lt;lgl&gt;
1 40000 NEA       1 NA     NA     NA    NA   
2 70000 NEA       1 NA     NA     NA    NA   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we schedule one Chimpanzee sample, 5 African samples, and 10 European samples</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>present_samples <span class="ot">&lt;-</span> <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="dv">0</span>, <span class="fu">list</span>(chimp, <span class="dv">1</span>), <span class="fu">list</span>(afr, <span class="dv">5</span>), <span class="fu">list</span>(eur, <span class="dv">10</span>))</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We also schedule the recording of one European sample between 50kya and 2kya,</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># every 2000 years</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">40000</span>, <span class="dv">2000</span>, <span class="at">by =</span> <span class="sc">-</span><span class="dv">2000</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>emh_samples <span class="ot">&lt;-</span> <span class="fu">schedule_sampling</span>(model, times, <span class="fu">list</span>(eur, <span class="dv">1</span>))</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Because those functions produce nothing but a data frame, we can bind</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co"># individual sampling schedules together</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>schedule <span class="ot">&lt;-</span> <span class="fu">rbind</span>(nea_samples, present_samples, emh_samples)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>schedule</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 25 × 7
    time pop       n y_orig x_orig y     x    
   &lt;int&gt; &lt;chr&gt; &lt;int&gt; &lt;lgl&gt;  &lt;lgl&gt;  &lt;lgl&gt; &lt;lgl&gt;
 1 40000 NEA       1 NA     NA     NA    NA   
 2 70000 NEA       1 NA     NA     NA    NA   
 3     0 CHIMP     1 NA     NA     NA    NA   
 4     0 AFR       5 NA     NA     NA    NA   
 5     0 EUR      10 NA     NA     NA    NA   
 6  2000 EUR       1 NA     NA     NA    NA   
 7  4000 EUR       1 NA     NA     NA    NA   
 8  6000 EUR       1 NA     NA     NA    NA   
 9  8000 EUR       1 NA     NA     NA    NA   
10 10000 EUR       1 NA     NA     NA    NA   
# ℹ 15 more rows</code></pre>
</div>
</div>
</div>
</div>
</div>
<p><strong>Then, verify the correctness of your overall sampling <code>schedule</code> by visualizing it together with your <code>model</code> like this:</strong></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> As you’ve seen above, the visualization is often a bit wonky and convoluted with overlapping elements and it can be even worse with samples added, but try to experiment with arguments to <code>plot_model</code> described above to make the plot a bit more helpful for sanity checking.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model, <span class="at">samples =</span> schedule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model, <span class="at">sizes =</span> <span class="cn">FALSE</span>, <span class="at">samples =</span> schedule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model, <span class="at">sizes =</span> <span class="cn">FALSE</span>, <span class="at">log =</span> <span class="cn">TRUE</span>, <span class="at">samples =</span> schedule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="part-6-simulating-a-defined-set-of-individuals" class="level3 page-columns page-full" data-number="4.0.6">
<h3 data-number="4.0.6" class="anchored" data-anchor-id="part-6-simulating-a-defined-set-of-individuals"><span class="header-section-number">4.0.6</span> Part 6: Simulating a defined set of individuals</h3>
<p>You have now both a compiled <em>slendr</em> <code>model</code> and a well-defined sampling <code>schedule</code>.</p>
<p><strong>Use your combined sampling schedule stored in the <code>schedule</code> variable to run a new tree-sequence simulation from your model (again using the <code>msprime()</code> function), this time restricted to just those individuals scheduled for recording. You can do this by providing the combined sampling <code>schedule</code> as the <code>samples = schedule</code> argument of the function <code>msprime</code> you used above.</strong> Just replace the line(s) with your first <code>msprime()</code> from the previous part of this exercise with the new one, which uses the <code>schedule</code> for customized sampling.</p>
<p><strong>Also, while you’re doing this, use the <code>ts_mutate()</code> function to overlay neutral mutations on the simulated tree sequence right after the <code>msprime()</code> call.</strong> (Take a look at the handounts for a reminder of the <code>%&gt;%</code> pipe patterns I showed you.)</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The command below will likely take a few minutes to run, so feel free to go</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co"># down from 100 Mb sequence_length to even 10Mb (it doesn't matter much).</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (The `random_seed =` argument is there for reproducibility purposes.)</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> <span class="fl">100e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>, <span class="at">samples =</span> schedule, <span class="at">random_seed =</span> <span class="dv">1269258439</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts_mutate</span>(<span class="at">mutation_rate =</span> <span class="fl">1e-8</span>, <span class="at">random_seed =</span> <span class="dv">1269258439</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Time difference of 2.141642 mins</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co"># If you're bothered by ho long this takes, feel free to call these two lines</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co"># to 100% reproduce my results without any expensive computation:</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">read_model</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/introgression"</span>))</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">ts_read</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="at">file =</span> <span class="st">"data/introgression.trees"</span>), <span class="at">model =</span> model)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="co"># We can save a tree sequence object using a slendr function `ts_write` (this</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="co"># can be useful if we want to save the results of a simulation for later use).</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">"data"</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_write</span>(ts, <span class="st">"data/introgression.trees"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p><strong>Inspect the tree-sequence object saved in the <code>ts</code> variable by typing it into the R console again</strong> (this interactivity really helps with catching nasty bugs early during the programming of your script). <strong>You can also do a similar thing via the table produced by the <code>ts_samples()</code> function. You should see a much smaller number of individuals being recorded, indicating that the simulation was much more efficient and produced genomic data for only the individuals of interest.</strong></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> When you think about it, it’s actually quite astonishing how fast <em>msprime</em> and <em>tskit</em> are when dealing with such a huge amount of sequence data from tens of thousands of individuals on a simple laptop!</p>
</div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the (tskit/Python-based) summary of the new tree sequence</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (note the much smaller number of "sample nodes"!)</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>ts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>╔═══════════════════════════╗
║TreeSequence               ║
╠═══════════════╤═══════════╣
║Trees          │     295199║
╟───────────────┼───────────╢
║Sequence Length│  100000000║
╟───────────────┼───────────╢
║Time Units     │generations║
╟───────────────┼───────────╢
║Sample Nodes   │         76║
╟───────────────┼───────────╢
║Total Size     │   85.1 MiB║
╚═══════════════╧═══════════╝
╔═══════════╤═══════╤═════════╤════════════╗
║Table      │Rows   │Size     │Has Metadata║
╠═══════════╪═══════╪═════════╪════════════╣
║Edges      │1051064│ 32.1 MiB│          No║
╟───────────┼───────┼─────────┼────────────╢
║Individuals│     38│  1.1 KiB│          No║
╟───────────┼───────┼─────────┼────────────╢
║Migrations │      0│  8 Bytes│          No║
╟───────────┼───────┼─────────┼────────────╢
║Mutations  │ 663287│ 23.4 MiB│          No║
╟───────────┼───────┼─────────┼────────────╢
║Nodes      │ 218703│  5.8 MiB│          No║
╟───────────┼───────┼─────────┼────────────╢
║Populations│      4│341 Bytes│         Yes║
╟───────────┼───────┼─────────┼────────────╢
║Provenances│      2│  5.7 KiB│          No║
╟───────────┼───────┼─────────┼────────────╢
║Sites      │ 660993│ 15.8 MiB│          No║
╚═══════════╧═══════╧═════════╧════════════╝</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the table of all recorded samples in the tree sequence</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 38 × 3
   name   time pop  
   &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;
 1 NEA_1 70000 NEA  
 2 EUR_1 40000 EUR  
 3 NEA_2 40000 NEA  
 4 EUR_2 38000 EUR  
 5 EUR_3 36000 EUR  
 6 EUR_4 34000 EUR  
 7 EUR_5 32000 EUR  
 8 EUR_6 30000 EUR  
 9 EUR_7 28000 EUR  
10 EUR_8 26000 EUR  
# ℹ 28 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the count of individuals in different time points</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(pop, <span class="at">present_day =</span> time <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> tally <span class="sc">%&gt;%</span> <span class="fu">select</span>(present_day, pop, n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
# Groups:   pop [4]
  present_day pop       n
  &lt;lgl&gt;       &lt;chr&gt; &lt;int&gt;
1 TRUE        AFR       5
2 TRUE        CHIMP     1
3 FALSE       EUR      20
4 TRUE        EUR      10
5 FALSE       NEA       2</code></pre>
</div>
</div>
</div>
</div>
</div>
<!-- End of Bonus exercises -->
</section>
</section>
<section id="computing-popgen-statistics-on-tree-sequences-from-slendr" class="level1 page-columns page-full" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Computing popgen statistics on tree sequences from <em>slendr</em></h1>
<p>In this exercise, you will build on top of the results from Exercise 1. Specifically, we will learn how to compute popgen statistics on <em>slendr</em>-simulated tree sequences using <a href="https://www.slendr.net/reference/index.html#tree-sequence-statistics"><em>slendr</em>’s interface</a> to the <em>tskit</em> Python module.</p>
<p><strong>First, create a new R script <code>exercise2.R</code> and paste in the following code.</strong> This is one of the possible solutions to the Exercise 1, and it’s easier if we all use it to be on the same page from now on, starting from the same model and the same simulated tree sequence:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slendr)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">init_env</span>()</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="do">## The interface to all required Python modules has been activated.</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>chimp <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"CHIMP"</span>, <span class="at">time =</span> <span class="fl">7e6</span>, <span class="at">N =</span> <span class="dv">5000</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>afr <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"AFR"</span>, <span class="at">parent =</span> chimp, <span class="at">time =</span> <span class="fl">6e6</span>, <span class="at">N =</span> <span class="dv">15000</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>eur <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"EUR"</span>, <span class="at">parent =</span> afr, <span class="at">time =</span> <span class="fl">70e3</span>, <span class="at">N =</span> <span class="dv">3000</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>nea <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"NEA"</span>, <span class="at">parent =</span> afr, <span class="at">time =</span> <span class="fl">600e3</span>, <span class="at">N =</span> <span class="dv">1000</span>, <span class="at">remove =</span> <span class="fl">40e3</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>gf <span class="ot">&lt;-</span> <span class="fu">gene_flow</span>(<span class="at">from =</span> nea, <span class="at">to =</span> eur, <span class="at">rate =</span> <span class="fl">0.03</span>, <span class="at">start =</span> <span class="dv">55000</span>, <span class="at">end =</span> <span class="dv">50000</span>)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">compile_model</span>(</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">populations =</span> <span class="fu">list</span>(chimp, nea, afr, eur),</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">gene_flow =</span> gf,</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">generation_time =</span> <span class="dv">30</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="co"># We will read a cached version of a tree sequence I simulated myself</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="co"># to make sure we're all on the same page. That said, if you managed to</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="co"># do Exercise 1 on your own, feel free to stick with your own tree sequence!</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">ts_read</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/introgression.trees"</span>), <span class="at">model =</span> model)</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_model</span>(model, <span class="at">proportions =</span> <span class="cn">TRUE</span>),</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_model</span>(model, <span class="at">proportions =</span> <span class="cn">TRUE</span>, <span class="at">log =</span> <span class="cn">TRUE</span>),</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="dv">1</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As a sanity check, let’s use a couple of tidyverse table-munging tricks to make sure the tree sequence does contain a set of sample which matches our intended sampling schedule (particularly the time series of European individuals and the two Neanderthals):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co"># total number of recorded individuals in the tree sequence</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span> nrow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 38</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># times of sampling of each recorded European individual</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(pop <span class="sc">==</span> <span class="st">"EUR"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 40000 38000 36000 34000 32000 30000 28000 26000 24000 22000 20000 18000
[13] 16000 14000 12000 10000  8000  6000  4000  2000     0     0     0     0
[25]     0     0     0     0     0     0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># times of sampling of each recorded Neanderthal</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(pop <span class="sc">==</span> <span class="st">"NEA"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 70000 40000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># count of individuals in each population</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(pop, <span class="at">present_day =</span> time <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  tally <span class="sc">%&gt;%</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pop, present_day, n) <span class="sc">%&gt;%</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(present_day)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
# Groups:   pop [4]
  pop   present_day     n
  &lt;chr&gt; &lt;lgl&gt;       &lt;int&gt;
1 EUR   FALSE          20
2 NEA   FALSE           2
3 AFR   TRUE            5
4 CHIMP TRUE            1
5 EUR   TRUE           10</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> These bits of tidyverse code are extremely helpful when you’re working with large tree sequences with many individuals as sanity checks that your sampling worked as intended. I’m listing them here in case you’ve never worked with the tidyverse family of R packages before (such as the <em>dplyr</em> package where <code>filter()</code>, <code>group_by()</code>, <code>tally()</code>, and <code>pull()</code> come from).</p>
</div></div><p>Everything looks good! Having made sure that the <code>ts</code> object contains the individuals we want, let’s move to the exercise.</p>
<section id="part-1-computing-nucleotide-diversity" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="part-1-computing-nucleotide-diversity"><span class="header-section-number">5.1</span> Part 1: Computing nucleotide diversity</h2>
<p>The toy model of ancient human history plotted above makes a fairly clear prediction of what would be the nucleotide diversity expected in the simulated populations. <strong>Compute the nucleotide diversity in all populations using the <em>slendr</em> function <a href="https://www.slendr.net/reference/ts_diversity.html#ref-examples"><code>ts_diversity()</code></a> in your tree sequence <code>ts</code>. Do you get numbers that (relatively between all populations) match what would expect from the model given the <span class="math inline">\(N_e\)</span> that you programmed for each?</strong></p>
<p><strong>Hint:</strong> Nearly every <em>slendr</em> statistic function interfacing with <em>tskit</em> accepts a <code>ts</code> tree-sequence object as its first argument, with further arguments being either a vector of individual names representing a group of samples to compute a statistic on, or a (named) list of such vectors (each element of that list for a group of samples) – these lists are intended to be equivalent to the <code>sample_sets =</code> argument of many <em>tskit</em> Python methods (which you’ve learned about in your activity on <em>tskit</em>), except that they allow symbolic names of individuals, rather then integer indices of nodes in a tree sequence.</p>
<p>Although you can get all the above information by processing the table produced by the <code>ts_samples()</code> function, <em>slendr</em> provides a useful helper function <code>ts_names()</code> which only returns the names of individuals as a vector (or a named list of such vectors, one vector per population as shown below).</p>
<p>When you call it directly, you get a plain vector of individual names:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_names</span>(ts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "NEA_1"   "EUR_1"   "NEA_2"   "EUR_2"   "EUR_3"   "EUR_4"   "EUR_5"  
 [8] "EUR_6"   "EUR_7"   "EUR_8"   "EUR_9"   "EUR_10"  "EUR_11"  "EUR_12" 
[15] "EUR_13"  "EUR_14"  "EUR_15"  "EUR_16"  "EUR_17"  "EUR_18"  "EUR_19" 
[22] "EUR_20"  "AFR_1"   "AFR_2"   "AFR_3"   "AFR_4"   "AFR_5"   "CHIMP_1"
[29] "EUR_21"  "EUR_22"  "EUR_23"  "EUR_24"  "EUR_25"  "EUR_26"  "EUR_27" 
[36] "EUR_28"  "EUR_29"  "EUR_30" </code></pre>
</div>
</div>
<p>This is not super helpful, unless we want to compute some statistic for <em>everyone</em> in the tree sequence, regardless of their population assignment. Perhaps a bit more useful is to call the function like this, because it will produce a result which can be immediately used as the <code>sample_sets =</code> argument mentioned in the <strong>Hint</strong> above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_names</span>(ts, <span class="at">split =</span> <span class="st">"pop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$AFR
[1] "AFR_1" "AFR_2" "AFR_3" "AFR_4" "AFR_5"

$CHIMP
[1] "CHIMP_1"

$EUR
 [1] "EUR_1"  "EUR_2"  "EUR_3"  "EUR_4"  "EUR_5"  "EUR_6"  "EUR_7"  "EUR_8" 
 [9] "EUR_9"  "EUR_10" "EUR_11" "EUR_12" "EUR_13" "EUR_14" "EUR_15" "EUR_16"
[17] "EUR_17" "EUR_18" "EUR_19" "EUR_20" "EUR_21" "EUR_22" "EUR_23" "EUR_24"
[25] "EUR_25" "EUR_26" "EUR_27" "EUR_28" "EUR_29" "EUR_30"

$NEA
[1] "NEA_1" "NEA_2"</code></pre>
</div>
</div>
<p>As you can see, this gave us a normal R list, with each element containing a vector of individual names in a population. Note that we can use standard R list indexing to get subsets of individuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">ts_names</span>(ts, <span class="at">split =</span> <span class="st">"pop"</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>names[<span class="st">"NEA"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$NEA
[1] "NEA_1" "NEA_2"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>names[<span class="fu">c</span>(<span class="st">"EUR"</span>, <span class="st">"NEA"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$EUR
 [1] "EUR_1"  "EUR_2"  "EUR_3"  "EUR_4"  "EUR_5"  "EUR_6"  "EUR_7"  "EUR_8" 
 [9] "EUR_9"  "EUR_10" "EUR_11" "EUR_12" "EUR_13" "EUR_14" "EUR_15" "EUR_16"
[17] "EUR_17" "EUR_18" "EUR_19" "EUR_20" "EUR_21" "EUR_22" "EUR_23" "EUR_24"
[25] "EUR_25" "EUR_26" "EUR_27" "EUR_28" "EUR_29" "EUR_30"

$NEA
[1] "NEA_1" "NEA_2"</code></pre>
</div>
</div>
<p>etc.</p>
<p>Many of the following exercises will use these kinds of tricks to instruct various <em>slendr</em> / <em>tskit</em> functions to compute statistics on subsets of all individuals sub-sampled in this way.</p>
<p><strong>After you computed nucleotide diversity per-population, compute it for each individual separately using the same function <code>ts_diversity()</code></strong> (which, in this setting, gives you effectively the heterozygosity for each individual). <strong>If you are familiar with plotting in R, visualize the individual-based heterozygosities across all populations.</strong></p>
<p><strong>Hint:</strong> You can do this by giving a vector of names as <code>sample_sets =</code> (so not an R list of vectors). You could also use the data frame produced by <code>ts_samples(ts)</code> to get the names, just adding the heterozygosities to that data frame as a new column.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><strong>Population-based nucleotide diversity:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's first get a named list of individuals in each group we want to be</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"># working with (slendr tree-sequence statistic functions generally operate</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># with this kind of structure)</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>sample_sets <span class="ot">&lt;-</span> <span class="fu">ts_names</span>(ts, <span class="at">split =</span> <span class="st">"pop"</span>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>sample_sets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$AFR
[1] "AFR_1" "AFR_2" "AFR_3" "AFR_4" "AFR_5"

$CHIMP
[1] "CHIMP_1"

$EUR
 [1] "EUR_1"  "EUR_2"  "EUR_3"  "EUR_4"  "EUR_5"  "EUR_6"  "EUR_7"  "EUR_8" 
 [9] "EUR_9"  "EUR_10" "EUR_11" "EUR_12" "EUR_13" "EUR_14" "EUR_15" "EUR_16"
[17] "EUR_17" "EUR_18" "EUR_19" "EUR_20" "EUR_21" "EUR_22" "EUR_23" "EUR_24"
[25] "EUR_25" "EUR_26" "EUR_27" "EUR_28" "EUR_29" "EUR_30"

$NEA
[1] "NEA_1" "NEA_2"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can use such `sample_sets` object to compute nucleotide diversity (pi)\</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># in each population, in a bit of a similar manner to how we would do it</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># with the standard tskit in Python</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>pi_pop <span class="ot">&lt;-</span> <span class="fu">ts_diversity</span>(ts, <span class="at">sample_sets =</span> sample_sets)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(pi_pop, diversity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  set   diversity
  &lt;chr&gt;     &lt;dbl&gt;
1 NEA   0.0000483
2 CHIMP 0.000196 
3 EUR   0.000510 
4 AFR   0.000600 </code></pre>
</div>
</div>
<p>You can see that this simple computation fits the extreme differences in long-term <span class="math inline">\(N_e\)</span> encoded by your <em>slendr</em> demografr model.</p>
<p><strong>Per-individual heterozygosity:</strong></p>
<p>We can do this by passing the vector of individual names directory as the <code>sample_sets =</code> argument, rather than in a list of groups as we did above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For convenience, we first get a table of all individuals (which of course</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># contains also their names) and in the next step, we'll just add their</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># heterozygosities as a new column.</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>pi_df <span class="ot">&lt;-</span> <span class="fu">ts_samples</span>(ts)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>pi_df<span class="sc">$</span>name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "NEA_1"   "EUR_1"   "NEA_2"   "EUR_2"   "EUR_3"   "EUR_4"   "EUR_5"  
 [8] "EUR_6"   "EUR_7"   "EUR_8"   "EUR_9"   "EUR_10"  "EUR_11"  "EUR_12" 
[15] "EUR_13"  "EUR_14"  "EUR_15"  "EUR_16"  "EUR_17"  "EUR_18"  "EUR_19" 
[22] "EUR_20"  "AFR_1"   "AFR_2"   "AFR_3"   "AFR_4"   "AFR_5"   "CHIMP_1"
[29] "EUR_21"  "EUR_22"  "EUR_23"  "EUR_24"  "EUR_25"  "EUR_26"  "EUR_27" 
[36] "EUR_28"  "EUR_29"  "EUR_30" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>pi_df<span class="sc">$</span>diversity <span class="ot">&lt;-</span> <span class="fu">ts_diversity</span>(ts, <span class="at">sample_sets =</span> pi_df<span class="sc">$</span>name)<span class="sc">$</span>diversity</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>pi_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 38 × 4
   name   time pop   diversity
   &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
 1 NEA_1 70000 NEA   0.0000431
 2 EUR_1 40000 EUR   0.000516 
 3 NEA_2 40000 NEA   0.0000410
 4 EUR_2 38000 EUR   0.000520 
 5 EUR_3 36000 EUR   0.000539 
 6 EUR_4 34000 EUR   0.000534 
 7 EUR_5 32000 EUR   0.000533 
 8 EUR_6 30000 EUR   0.000553 
 9 EUR_7 28000 EUR   0.000499 
10 EUR_8 26000 EUR   0.000506 
# ℹ 28 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's plot the results using the ggplot2 package</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (because a picture is worth a thousand numbers!)</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pi_df, <span class="fu">aes</span>(pop, diversity, <span class="at">color =</span> pop, <span class="at">group =</span> pop)) <span class="sc">+</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>() <span class="sc">+</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="part-2-computing-pairwise-divergence" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="part-2-computing-pairwise-divergence"><span class="header-section-number">5.2</span> Part 2: Computing pairwise divergence</h2>
<p><strong>Use the function <a href="https://www.slendr.net/reference/ts_divergence.html#ref-examples"><code>ts_divergence()</code></a> to compute genetic divergence between all pairs of populations. Again, do you get results compatible with our demographic model in terms of expectation given the split times between populations as you programmed them for your model?</strong></p>
<p><strong>Hint:</strong> Again, you can use the same concept of <code>sample_sets =</code> we discussed in the previous part. In this case, the function computes <em>pairwise</em> divergence between each element of the list given as <code>sample_sets =</code> (i.e., for each vector of individual names).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>sample_sets <span class="ot">&lt;-</span> <span class="fu">ts_names</span>(ts, <span class="at">split =</span> <span class="st">"pop"</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>div_df <span class="ot">&lt;-</span> <span class="fu">ts_divergence</span>(ts, sample_sets)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(div_df, divergence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  x     y     divergence
  &lt;chr&gt; &lt;chr&gt;      &lt;dbl&gt;
1 AFR   EUR     0.000649
2 EUR   NEA     0.000955
3 AFR   NEA     0.000983
4 CHIMP NEA     0.00416 
5 CHIMP EUR     0.00417 
6 AFR   CHIMP   0.00418 </code></pre>
</div>
</div>
<p>We can see that the pairwise nucleotide divergences between populations recapitulate the known population/species relationships we would expect from our model.</p>
</div>
</div>
</div>
</section>
<section id="part-3-detecting-neanderthal-admixture-in-europeans" class="level2 page-columns page-full" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="part-3-detecting-neanderthal-admixture-in-europeans"><span class="header-section-number">5.3</span> Part 3: Detecting Neanderthal admixture in Europeans</h2>
<p>Let’s now pretend its about 2008, we’ve sequenced the first Neanderthal genome, and we are working on a project that will <a href="https://www.science.org/doi/10.1126/science.1188021">change human evolution research forever</a>. We also have the genomes of a couple of people from Africa and Europe, which we want to use to answer the most burning question of all evolutionary anthropology: <em>“Do some people living today carry Neanderthal ancestry?”</em></p>
<p>Earlier you’ve learned about <span class="math inline">\(f\)</span>-statistics of various kinds. You have also heard that an <span class="math inline">\(f_4\)</span> statistic (or its equivalent <span class="math inline">\(D\)</span> statistic) can be used as a test of “treeness”. Simply speaking, for some “quartet” of individuals or population samples, they can be used as a hypothesis test of whether the history of those samples is compatible with there not having been an introgression.</p>
<p><strong>Compute the <span class="math inline">\(f_4\)</span> test of Neanderthal introgression in EUR individuals using the <em>slendr</em> function <code>ts_f4()</code>.</strong> When you’re running it, you will have to provide individuals to compute the statistic using a slightly different format. Take a look at the help page available as <code>?ts_f4</code> for more information. <strong>When you’re computing the <span class="math inline">\(f_4\)</span>, make sure to set <code>mode = "branch"</code> argument of the <code>ts_f4()</code> function (we will get to why a bit later).</strong></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> By default, each <em>slendr</em> / <em>tskit</em> statistic function operates on mutations, and this will switch them to use branch length (as you might know, <span class="math inline">\(f\)</span>-statistics are mathematically defined using branch lengths in trees and <code>mode = "branch"</code> does exactly that).</p>
</div></div><p><strong>Hint:</strong> If you haven’t learned this in your <span class="math inline">\(f\)</span>-statistics lecture, you want to compute (and compare) the values of these two statistics using the <em>slendr</em> function <code>ts_f4()</code>:</p>
<ol type="1">
<li><p><span class="math inline">\(f_4\)</span>(&lt;some African&gt;, &lt;another African&gt;; &lt;Neanderthal&gt;, &lt;Chimp&gt;)</p></li>
<li><p><span class="math inline">\(f_4\)</span>(&lt;some African&gt;, &lt;a test European&gt;; &lt;Neanderthal&gt;, &lt;Chimp&gt;),</p></li>
</ol>
<p>here <code>&lt;individual&gt;</code> can be the name of any individual recorded in your tree sequence, such as names you saw as <code>name</code> column in the table returned by <code>ts_samples(ts)</code> (i.e.&nbsp;<code>"NEA_1"</code> could be used as a “representative” &lt;Neanderthal&gt; in those equations, similarly for <code>"CHIMP_1"</code> as the fourth sample in the <span class="math inline">\(f_4\)</span> quarted representing the outgroup).</p>
<p>To simplify things a lot, we can understand the above equations as comparing the counts of so-called BABA and ABBA allele patterns between the quarted of samples specified in the statistics:</p>
<p><span class="math display">\[
f_4(AFR, X; NEA, CHIMP) = \frac{\#BABA - \#ABBA}{\#SNPs}
\]</span></p>
<p>The first <span class="math inline">\(f_4\)</span> statistic above is not expected to give values “too different” from 0 (even in case of Neanderthal introgression into Europeans) because we don’t expect two African individuals to differ “significantly” in terms of how much alleles they share with a Neanderthal (because their ancestors never met Neanderthals!). The other should – if there was a Neanderthal introgression into Europeans some time in their history – be “significantly negative”.</p>
<p><strong>Is the second of those two statistics “much more negative” than the first, as expected assuming introgression from Neanderthals into Europeans?</strong></p>
<p><strong>Why am I putting “significantly” and “much more negative” in quotes in the previous sentence? What are we missing here for this being a true hypothesis test as you might be accustomed to from computing <span class="math inline">\(f\)</span>-statistics using a tool such as ADMIXTOOLS?</strong> (We will get to this again in the following part of this exercise.)</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the difference in the amount of allele sharing between two African</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co"># individuals and a Neanderthal</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>f4_null <span class="ot">&lt;-</span> <span class="fu">ts_f4</span>(ts, <span class="at">W =</span> <span class="st">"AFR_1"</span>, <span class="at">X =</span> <span class="st">"AFR_2"</span>, <span class="at">Y =</span> <span class="st">"NEA_1"</span>, <span class="at">Z =</span> <span class="st">"CHIMP_1"</span>, <span class="at">mode =</span> <span class="st">"branch"</span>)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>f4_null</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  W     X     Y     Z          f4
  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
1 AFR_1 AFR_2 NEA_1 CHIMP_1  43.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the difference in the amount of allele sharing between an African</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co"># individual vs European individual and a Neanderthal</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>f4_alt <span class="ot">&lt;-</span> <span class="fu">ts_f4</span>(ts, <span class="at">W =</span> <span class="st">"AFR_1"</span>, <span class="at">X =</span> <span class="st">"EUR_1"</span>, <span class="at">Y =</span> <span class="st">"NEA_1"</span>, <span class="at">Z =</span> <span class="st">"CHIMP_1"</span>, <span class="at">mode =</span> <span class="st">"branch"</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>f4_alt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  W     X     Y     Z          f4
  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
1 AFR_1 EUR_1 NEA_1 CHIMP_1 -853.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can see that the second test resulted in an f4 value about ~20 times more</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co"># negative than the first test, indicating that a European in our test carries</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="co"># "significantly more" Neanderthal alleles compared to the baseline expectation</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># of no introgression established by the comparison to an African ...</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abs</span>(f4_alt<span class="sc">$</span>f4 <span class="sc">/</span> f4_null<span class="sc">$</span>f4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 19.65719</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... although this is not a real test of significance (we have no Z-score or</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co"># standard error which would give us something like a p-value for the hypothesis</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co"># test, as we get by jackknife procedure in ADMIXTOOLS)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="part-4-detecting-neanderthal-admixture-in-europeans-v2.0" class="level2 page-columns page-full" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="part-4-detecting-neanderthal-admixture-in-europeans-v2.0"><span class="header-section-number">5.4</span> Part 4: Detecting Neanderthal admixture in Europeans v2.0</h2>
<p>The fact that we don’t get something equivalent to a p-value in these kinds of simulations is generally not a problem, because we’re often interested in establishing a trend of a statistic under various conditions, and understanding when and how its <em>expected value</em> behaves in a certain way. If statistical noise is a problem, we work around this by computing a statistic on multiple simulation replicates or even increasing the sample sizes.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> To see this in practice, you can check out a <a href="https://www.pnas.org/doi/10.1073/pnas.1814338116#fig02">paper</a> in which I used this approach quite successfully on a related problem.</p>
</div></div><p>On top of that, p-value of something like an <span class="math inline">\(f\)</span>-statistic (whether it’s significantly different from zero) is also strongly affected by quality of the data, sequencing errors, coverage, etc. (which can certainly be examined using simulations!). However, these are aspects of modeling which are quite orthogonal to the problem of investigating the expectations and trends of statistics given some underlying evolutionary model, which is what we’re after in these exercises.</p>
<p>That said, even in perfect simulated data, what exactly does “significantly different from zero compared to some baseline expectation” mean can be blurred by noise with simple single-individual comparisons that we did above. Let’s increase the sample size a bit to see if a statistical pattern expected in <span class="math inline">\(f_4\)</span> statistic from our Neanderthal introgression model becomes more apparent.</p>
<p><strong>Compute the first <span class="math inline">\(f_4\)</span> statistic (the baseline expectation between a pair of Africans) and the second <span class="math inline">\(f_4\)</span> statistic (comparing an African and a European), but this time on <em>all recorded Africans</em> and <em>all recorded Europeans</em>, respectively. Plot the <em>distributions</em> of those two sets of statistics. This should remove lots of the uncertainty and make a statistical trend stand out much more clearly.</strong></p>
<p><strong>Hint:</strong> Whenever you need to compute something for many things in sequence, looping is very useful. One way to do compute, say, an <span class="math inline">\(f_4\)</span> statistic over many individuals is by using this kind of pattern using R’s looping function <code>lapply()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over vector of individual names (variable x) and apply a given ts_f4()</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="co"># expression on each individual (note the ts_f4(..., X = x, ...) in the code)</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>list_f4 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"ind_1"</span>, <span class="st">"ind_2"</span>, ...),</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) <span class="fu">ts_f4</span>(ts, <span class="at">W =</span> <span class="st">"AFR_1"</span>, <span class="at">X =</span> x, <span class="at">Y =</span> <span class="st">"NEA_1"</span>, <span class="at">Z =</span> <span class="st">"CHIMP_1"</span>, <span class="at">mode =</span> <span class="st">"branch"</span>)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="co"># The above gives us a list of data frames, so we need to bind them all into a</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="co"># single table for easier interpretation and visualization</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>df_f4 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, list_f4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This gives us list of vectors of the names of all individuals in each</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># population...</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>sample_sets <span class="ot">&lt;-</span> <span class="fu">ts_names</span>(ts, <span class="at">split =</span> <span class="st">"pop"</span>)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ... which we can then access like this</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>sample_sets<span class="sc">$</span>AFR <span class="co"># all Africans</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "AFR_1" "AFR_2" "AFR_3" "AFR_4" "AFR_5"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>sample_sets<span class="sc">$</span>EUR <span class="co"># all Europeans</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "EUR_1"  "EUR_2"  "EUR_3"  "EUR_4"  "EUR_5"  "EUR_6"  "EUR_7"  "EUR_8" 
 [9] "EUR_9"  "EUR_10" "EUR_11" "EUR_12" "EUR_13" "EUR_14" "EUR_15" "EUR_16"
[17] "EUR_17" "EUR_18" "EUR_19" "EUR_20" "EUR_21" "EUR_22" "EUR_23" "EUR_24"
[25] "EUR_25" "EUR_26" "EUR_27" "EUR_28" "EUR_29" "EUR_30"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's compute the f4 statistic for all Africans... </span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>f4_afr_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  sample_sets<span class="sc">$</span>AFR,</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) <span class="fu">ts_f4</span>(ts, <span class="at">W =</span> <span class="st">"AFR_1"</span>, <span class="at">X =</span> x, <span class="at">Y =</span> <span class="st">"NEA_1"</span>, <span class="at">Z =</span> <span class="st">"CHIMP_1"</span>, <span class="at">mode =</span> <span class="st">"branch"</span>)</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ... and Europeans</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>f4_eur_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>  sample_sets<span class="sc">$</span>EUR,</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) <span class="fu">ts_f4</span>(ts, <span class="at">W =</span> <span class="st">"AFR_1"</span>, <span class="at">X =</span> x, <span class="at">Y =</span> <span class="st">"NEA_1"</span>, <span class="at">Z =</span> <span class="st">"CHIMP_1"</span>, <span class="at">mode =</span> <span class="st">"branch"</span>)</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind each list of data frames into a single data frame</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>f4_afr <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, f4_afr_list)</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>f4_eur <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, f4_eur_list)</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's add population columns to each of the two results for easier plotting</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>f4_afr<span class="sc">$</span>pop <span class="ot">&lt;-</span> <span class="st">"AFR"</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>f4_eur<span class="sc">$</span>pop <span class="ot">&lt;-</span> <span class="st">"EUR"</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind both tables together</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>f4_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(f4_afr, f4_eur)</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the results</span></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>f4_results <span class="sc">%&gt;%</span></span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(pop, f4, <span class="at">color =</span> pop)) <span class="sc">+</span></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>() <span class="sc">+</span></span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"f4(AFR, EUR; NEA, CHIMP)"</span>) <span class="sc">+</span></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that the <span class="math inline">\(f_4\)</span> statistic test of Neanderthal introgression in Europeans indeed does give a much more negative distribution of values compared to the baseline expectation which compares two Africans to each other.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-21-contents" aria-controls="callout-21" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bonus exercises
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-21" class="callout-21-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="bonus-1-mode-branch-vs-mode-site" class="level3" data-number="5.4.1">
<h3 data-number="5.4.1" class="anchored" data-anchor-id="bonus-1-mode-branch-vs-mode-site"><span class="header-section-number">5.4.1</span> Bonus 1: <code>mode = "branch"</code> vs <code>mode = "site"</code></h3>
<p><strong>Repeat the previous part of the exercise by setting <code>mode = "site"</code> in the <code>ts_f4()</code> function calls</strong> (this is actually the default behavior of all <em>slendr</em> tree-sequence based <em>tskit</em> functions). This will switch the <em>tskit</em> computation to using mutation counts along each branch of the tree sequence, rather than using branch length themselves. <strong>Why might the branch-based computation be a bit better if what we’re after is investigating the expected values of statistics under some model?</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>See <a href="https://tskit.dev/tutorials/no_mutations.html#genealogy-based-measures-are-less-noisy">this tutorial</a> (and particularly the directly linked section) for explanation.</p>
</div>
</div>
</div>
</section>
<section id="bonus-2-outgroup-f_3-statistic" class="level3" data-number="5.4.2">
<h3 data-number="5.4.2" class="anchored" data-anchor-id="bonus-2-outgroup-f_3-statistic"><span class="header-section-number">5.4.2</span> Bonus 2: Outgroup <span class="math inline">\(f_3\)</span> statistic</h3>
<p><strong>Use the function <code>ts_f3()</code> to compute the outgroup</strong> <span class="math inline">\(f_3\)</span> statistic between pairs of African-European, African-Neanderthal, and European-Neanderthal and a Chimpanzee outgroup.</p>
<p><strong>Hint:</strong> The <span class="math inline">\(f_3\)</span> statistic is traditionally expressed as <span class="math inline">\(f_3(A, B; C)\)</span>, where C represents the outgroup. Unfortunately, in <em>tskit</em> the outgroup is named A, with B and C being the pair of samples from which we trace the length of branches towards the outgroup, so the statistic is interpreted as <span class="math inline">\(f_3(B, C; A)\)</span>.</p>
<p><strong>How do the outgroup f3 results compare to your expectation based on simple population relationships (and to the divergence computation above)?</strong></p>
<p><strong>Do you see any impact of introgression on the <span class="math inline">\(f_3\)</span> value when a Neanderthal is included in the computation?</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># f3(A, B; C) = E[ (A - C) * (B - C) ]</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This means that in tskit, C is the outgroup (different from ADMIXTOOLS!)</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We can compute f3 for individuals...</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_f3</span>(ts, <span class="at">B =</span> <span class="st">"AFR_1"</span>, <span class="at">C =</span> <span class="st">"EUR_1"</span>, <span class="at">A =</span> <span class="st">"CHIMP_1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  A       B     C          f3
  &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
1 CHIMP_1 AFR_1 EUR_1 0.00375</code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... but also whole populations (or population samples)</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_f3</span>(ts, <span class="at">B =</span> sample_sets[<span class="st">"AFR"</span>], <span class="at">C =</span> sample_sets[<span class="st">"EUR"</span>], <span class="at">A =</span> <span class="st">"CHIMP_1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  A       B     C          f3
  &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
1 CHIMP_1 AFR   EUR   0.00375</code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_f3</span>(ts, <span class="at">B =</span> sample_sets[<span class="st">"AFR"</span>], <span class="at">C =</span> sample_sets[<span class="st">"NEA"</span>], <span class="at">A =</span> <span class="st">"CHIMP_1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  A       B     C          f3
  &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
1 CHIMP_1 AFR   NEA   0.00358</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_f3</span>(ts, <span class="at">B =</span> sample_sets[<span class="st">"EUR"</span>], <span class="at">C =</span> sample_sets[<span class="st">"NEA"</span>], <span class="at">A =</span> <span class="st">"CHIMP_1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  A       B     C          f3
  &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
1 CHIMP_1 EUR   NEA   0.00359</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="bonus-3-outgroup-f_3-statistic-as-a-linear-combination-of-f_2-statistics" class="level3" data-number="5.4.3">
<h3 data-number="5.4.3" class="anchored" data-anchor-id="bonus-3-outgroup-f_3-statistic-as-a-linear-combination-of-f_2-statistics"><span class="header-section-number">5.4.3</span> Bonus 3: Outgroup <span class="math inline">\(f_3\)</span> statistic as a linear combination of <span class="math inline">\(f_2\)</span> statistics</h3>
<p>You might have learned that any complex <span class="math inline">\(f\)</span>-statistic can be expressed as a linear combination of multiple <span class="math inline">\(f_2\)</span> statistics (which represent simple branch length separating two lineages). <strong>Verify that this is the case by looking up equation <em>(20b)</em> in <a href="https://academic.oup.com/genetics/article/202/4/1485/5930214">this amazing paper</a> and compute an</strong> <span class="math inline">\(f_3\)</span> statistic for any arbitrary trio of individuals of your choosing using this linear combination of <span class="math inline">\(f_2\)</span> statistics.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># standard f3</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_f3</span>(ts, <span class="at">B =</span> <span class="st">"AFR_1"</span>, <span class="at">C =</span> <span class="st">"AFR_2"</span>, <span class="at">A =</span> <span class="st">"CHIMP_1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  A       B     C          f3
  &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
1 CHIMP_1 AFR_1 AFR_2 0.00378</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a "homemade" f3 statistic as a linear combination of f2 statistics</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="co"># f3(A, B; C) = f2(A, C) + f2(B, C) - f2(A, B) / 2</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>homemade_f3 <span class="ot">&lt;-</span> (</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts_f2</span>(ts, <span class="at">A =</span> <span class="st">"AFR_1"</span>, <span class="at">B =</span> <span class="st">"CHIMP_1"</span>)<span class="sc">$</span>f2 <span class="sc">+</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts_f2</span>(ts, <span class="at">A =</span> <span class="st">"AFR_2"</span>, <span class="at">B =</span> <span class="st">"CHIMP_1"</span>)<span class="sc">$</span>f2 <span class="sc">-</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts_f2</span>(ts, <span class="at">A =</span> <span class="st">"AFR_1"</span>, <span class="at">B =</span> <span class="st">"AFR_2"</span>)<span class="sc">$</span>f2</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>homemade_f3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.003778796</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="bonus-4-trajectory-of-neanderthal-ancestry-in-europe-over-time" class="level3" data-number="5.4.4">
<h3 data-number="5.4.4" class="anchored" data-anchor-id="bonus-4-trajectory-of-neanderthal-ancestry-in-europe-over-time"><span class="header-section-number">5.4.4</span> Bonus 4: Trajectory of Neanderthal ancestry in Europe over time</h3>
<p>There used to be a lot of controversy about the question of whether or not did Neanderthal ancestry proportion in Europeans decline or not over the past 40 thousand years (see figure 1 in <a href="https://www.pnas.org/doi/full/10.1073/pnas.1814338116">this paper</a> figure 2 in <a href="https://www.nature.com/articles/nature17993">this paper</a>).</p>
<p>Your simulated tree sequence contains a time-series of European individuals over time. Use the <em>slendr</em> function <code>ts_f4ratio()</code> to compute (and then plot) the proportion (commonly designated as <code>alpha</code>) of Neanderthal ancestry in Europe over time. Use <span class="math inline">\(f_4\)</span>-ratio statistic of the following form:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_f4ratio</span>(ts, <span class="at">X =</span> <span class="sc">&lt;</span>vector of ind. names<span class="sc">&gt;</span>, <span class="at">A =</span> <span class="st">"NEA_1"</span>, <span class="at">B =</span> <span class="st">"NEA_2"</span>, <span class="at">C =</span> <span class="st">"AFR_1"</span>, <span class="at">O =</span> <span class="st">"CHIMP_1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract table with names and times of sampled Europeans (ancient and present day)</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>eur_inds <span class="ot">&lt;-</span> <span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(pop <span class="sc">==</span> <span class="st">"EUR"</span>)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>eur_inds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 3
   name    time pop  
   &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;
 1 EUR_1  40000 EUR  
 2 EUR_2  38000 EUR  
 3 EUR_3  36000 EUR  
 4 EUR_4  34000 EUR  
 5 EUR_5  32000 EUR  
 6 EUR_6  30000 EUR  
 7 EUR_7  28000 EUR  
 8 EUR_8  26000 EUR  
 9 EUR_9  24000 EUR  
10 EUR_10 22000 EUR  
# ℹ 20 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute f4-ration statistic (this will take ~30s) -- note that we can provide</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="co"># a vector of names for the X sample set to the `ts_f4ratio()` function</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>nea_ancestry <span class="ot">&lt;-</span> <span class="fu">ts_f4ratio</span>(ts, <span class="at">X =</span> eur_inds<span class="sc">$</span>name, <span class="at">A =</span> <span class="st">"NEA_1"</span>, <span class="at">B =</span> <span class="st">"NEA_2"</span>, <span class="at">C =</span> <span class="st">"AFR_1"</span>, <span class="at">O =</span> <span class="st">"CHIMP_1"</span>)</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the age of each sample to the table of proportions</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>nea_ancestry<span class="sc">$</span>time <span class="ot">&lt;-</span> eur_inds<span class="sc">$</span>time</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>nea_ancestry</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 7
   X      A     B     C     O        alpha  time
   &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
 1 EUR_1  NEA_1 NEA_2 AFR_1 CHIMP_1 0.0153 40000
 2 EUR_2  NEA_1 NEA_2 AFR_1 CHIMP_1 0.0170 38000
 3 EUR_3  NEA_1 NEA_2 AFR_1 CHIMP_1 0.0117 36000
 4 EUR_4  NEA_1 NEA_2 AFR_1 CHIMP_1 0.0201 34000
 5 EUR_5  NEA_1 NEA_2 AFR_1 CHIMP_1 0.0261 32000
 6 EUR_6  NEA_1 NEA_2 AFR_1 CHIMP_1 0.0132 30000
 7 EUR_7  NEA_1 NEA_2 AFR_1 CHIMP_1 0.0151 28000
 8 EUR_8  NEA_1 NEA_2 AFR_1 CHIMP_1 0.0243 26000
 9 EUR_9  NEA_1 NEA_2 AFR_1 CHIMP_1 0.0195 24000
10 EUR_10 NEA_1 NEA_2 AFR_1 CHIMP_1 0.0243 22000
# ℹ 20 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>nea_ancestry <span class="sc">%&gt;%</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(time, alpha)) <span class="sc">+</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">40000</span>, <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"time [years ago]"</span>, <span class="at">y =</span> <span class="st">"Neanderthal ancestry proportion"</span>) <span class="sc">+</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Neanderthal ancestry proportion in Europeans over time"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For good measure, let's test the significance of the decline using a linear model</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(alpha <span class="sc">~</span> time, <span class="at">data =</span> nea_ancestry))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = alpha ~ time, data = nea_ancestry)

Residuals:
       Min         1Q     Median         3Q        Max 
-0.0102725 -0.0029417  0.0001505  0.0040630  0.0073792 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  2.205e-02  1.214e-03  18.173   &lt;2e-16 ***
time        -1.031e-07  6.204e-08  -1.662    0.108    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.004642 on 28 degrees of freedom
Multiple R-squared:  0.08979,   Adjusted R-squared:  0.05728 
F-statistic: 2.762 on 1 and 28 DF,  p-value: 0.1077</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="bonus-5-how-many-unique-f4-quartets-are-there" class="level3" data-number="5.4.5">
<h3 data-number="5.4.5" class="anchored" data-anchor-id="bonus-5-how-many-unique-f4-quartets-are-there"><span class="header-section-number">5.4.5</span> Bonus 5: How many unique f4 quartets are there?</h3>
<p>In your lecture about <span class="math inline">\(f\)</span>-statistics, you’ve probably learned about various symmetries in <span class="math inline">\(f_4\)</span> (but also other <span class="math inline">\(f\)</span>-statistics) depending on the arrangement of the “quartet”. As a trivial example, an <span class="math inline">\(f_3(A; B, C)\)</span> and <span class="math inline">\(f_3(A; C, B)\)</span> will give you exactly the same value, and the same thing applies even to more complex <span class="math inline">\(f\)</span>-statistics like <span class="math inline">\(f_4\)</span>.</p>
<p><strong>Use simulations to compute how manu unique</strong> <span class="math inline">\(f_4\)</span> values involving a single quartet are there.</p>
<p><strong>Hint:</strong> Draw some trees to figure out why could that be true. Also, when computing <code>ts_f4()</code>, set <code>mode = "branch"</code> to avoid the effect of statistical noise due to mutations.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # install a combinatorics R package</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("combinat")</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(combinat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'combinat'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    combn</code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># These are the four samples we can create quartet combinations from</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>quartet <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"AFR_1"</span>, <span class="st">"EUR_1"</span>, <span class="st">"NEA_1"</span>, <span class="st">"CHIMP_1"</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>quartets <span class="ot">&lt;-</span> <span class="fu">permn</span>(quartet)</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>quartets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "AFR_1"   "EUR_1"   "NEA_1"   "CHIMP_1"

[[2]]
[1] "AFR_1"   "EUR_1"   "CHIMP_1" "NEA_1"  

[[3]]
[1] "AFR_1"   "CHIMP_1" "EUR_1"   "NEA_1"  

[[4]]
[1] "CHIMP_1" "AFR_1"   "EUR_1"   "NEA_1"  

[[5]]
[1] "CHIMP_1" "AFR_1"   "NEA_1"   "EUR_1"  

[[6]]
[1] "AFR_1"   "CHIMP_1" "NEA_1"   "EUR_1"  

[[7]]
[1] "AFR_1"   "NEA_1"   "CHIMP_1" "EUR_1"  

[[8]]
[1] "AFR_1"   "NEA_1"   "EUR_1"   "CHIMP_1"

[[9]]
[1] "NEA_1"   "AFR_1"   "EUR_1"   "CHIMP_1"

[[10]]
[1] "NEA_1"   "AFR_1"   "CHIMP_1" "EUR_1"  

[[11]]
[1] "NEA_1"   "CHIMP_1" "AFR_1"   "EUR_1"  

[[12]]
[1] "CHIMP_1" "NEA_1"   "AFR_1"   "EUR_1"  

[[13]]
[1] "CHIMP_1" "NEA_1"   "EUR_1"   "AFR_1"  

[[14]]
[1] "NEA_1"   "CHIMP_1" "EUR_1"   "AFR_1"  

[[15]]
[1] "NEA_1"   "EUR_1"   "CHIMP_1" "AFR_1"  

[[16]]
[1] "NEA_1"   "EUR_1"   "AFR_1"   "CHIMP_1"

[[17]]
[1] "EUR_1"   "NEA_1"   "AFR_1"   "CHIMP_1"

[[18]]
[1] "EUR_1"   "NEA_1"   "CHIMP_1" "AFR_1"  

[[19]]
[1] "EUR_1"   "CHIMP_1" "NEA_1"   "AFR_1"  

[[20]]
[1] "CHIMP_1" "EUR_1"   "NEA_1"   "AFR_1"  

[[21]]
[1] "CHIMP_1" "EUR_1"   "AFR_1"   "NEA_1"  

[[22]]
[1] "EUR_1"   "CHIMP_1" "AFR_1"   "NEA_1"  

[[23]]
[1] "EUR_1"   "AFR_1"   "CHIMP_1" "NEA_1"  

[[24]]
[1] "EUR_1"   "AFR_1"   "NEA_1"   "CHIMP_1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many permutations there are in total?</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   4! = 4 * 3 * 2 * 1 = 24</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="fu">factorial</span>(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24</code></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We should therefore have 24 different quartet combinations of samples</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(quartets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop across all quartets, computing the corresponding f4 statistic (we want</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to do this using branch lengths, not mutations, as the mutation-based computation</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="co"># would involve statistical noise)</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>all_f4s <span class="ot">&lt;-</span> <span class="fu">lapply</span>(quartets, <span class="cf">function</span>(q) <span class="fu">ts_f4</span>(ts, q[<span class="dv">1</span>], q[<span class="dv">2</span>], q[<span class="dv">3</span>], q[<span class="dv">4</span>], <span class="at">mode =</span> <span class="st">"branch"</span>))</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind the list of f4 results into a single data frame and inspect the results</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>all_f4s <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_f4s) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">abs</span>(f4))</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(all_f4s, <span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   W       X       Y       Z            f4
   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;
 1 AFR_1   EUR_1   NEA_1   CHIMP_1   -853.
 2 AFR_1   EUR_1   CHIMP_1 NEA_1      853.
 3 NEA_1   CHIMP_1 AFR_1   EUR_1     -853.
 4 CHIMP_1 NEA_1   AFR_1   EUR_1      853.
 5 CHIMP_1 NEA_1   EUR_1   AFR_1     -853.
 6 NEA_1   CHIMP_1 EUR_1   AFR_1      853.
 7 EUR_1   AFR_1   CHIMP_1 NEA_1     -853.
 8 EUR_1   AFR_1   NEA_1   CHIMP_1    853.
 9 AFR_1   NEA_1   CHIMP_1 EUR_1   -16428.
10 AFR_1   NEA_1   EUR_1   CHIMP_1  16428.
11 NEA_1   AFR_1   EUR_1   CHIMP_1 -16428.
12 NEA_1   AFR_1   CHIMP_1 EUR_1    16428.
13 EUR_1   CHIMP_1 NEA_1   AFR_1   -16428.
14 CHIMP_1 EUR_1   NEA_1   AFR_1    16428.
15 CHIMP_1 EUR_1   AFR_1   NEA_1   -16428.
16 EUR_1   CHIMP_1 AFR_1   NEA_1    16428.
17 AFR_1   CHIMP_1 EUR_1   NEA_1    17281.
18 CHIMP_1 AFR_1   EUR_1   NEA_1   -17281.
19 CHIMP_1 AFR_1   NEA_1   EUR_1    17281.
20 AFR_1   CHIMP_1 NEA_1   EUR_1   -17281.
21 NEA_1   EUR_1   CHIMP_1 AFR_1    17281.
22 NEA_1   EUR_1   AFR_1   CHIMP_1 -17281.
23 EUR_1   NEA_1   AFR_1   CHIMP_1  17281.
24 EUR_1   NEA_1   CHIMP_1 AFR_1   -17281.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Narrow down the results to only unique f4 values</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(all_f4s, f4, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  W       X       Y       Z            f4
  &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;
1 AFR_1   EUR_1   NEA_1   CHIMP_1   -853.
2 AFR_1   EUR_1   CHIMP_1 NEA_1      853.
3 AFR_1   NEA_1   CHIMP_1 EUR_1   -16428.
4 AFR_1   NEA_1   EUR_1   CHIMP_1  16428.
5 AFR_1   CHIMP_1 EUR_1   NEA_1    17281.
6 CHIMP_1 AFR_1   EUR_1   NEA_1   -17281.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(all_f4s, <span class="fu">abs</span>(f4), <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  W     X       Y       Z            f4 `abs(f4)`
  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 AFR_1 EUR_1   NEA_1   CHIMP_1   -853.      853.
2 AFR_1 NEA_1   CHIMP_1 EUR_1   -16428.    16428.
3 AFR_1 CHIMP_1 EUR_1   NEA_1    17281.    17281.</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</div>
</div>
</div>
<!-- End of Bonus exercises -->
</section>
</section>
<section id="simulation-based-inference-of-n_e" class="level1 page-columns page-full" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Simulation-based inference of <span class="math inline">\(N_e\)</span></h1>
<p>So far we’ve learned how <em>slendr</em> provides an easy way to define demographic models in R and simulate (even very large!) tree sequences from them. This allows us to quickly verify our intuition about some popgen problem (things like <em>“Hmmm, I wonder what would an <span class="math inline">\(f_4\)</span> statistic look like if my model includes this particular gene-flow event?</em>), in just a few lines of R. There have been instances in which we’ve been able to even answer questions like this directly in a meeting, pretty much on the spot! This makes <em>slendr</em> a very powerful “popgen calculator”.</p>
<p>Now let’s take things one step further. Imagine you gathered some empirical data, like an allele frequency spectrum (AFS) from a population that you study. That data was, in the real world, produced by some (hidden) biological process (demographic history) that we want to learn about. For instance, the population we study had some <span class="math inline">\(N_e\)</span>, which we don’t know the value of (the only thing we have is the observed AFS) but we want to infer that value.</p>
<p>Simulations can be a great tool to estimate the most likely value of such an unknown parameter. Briefly speaking, in this particular toy example, we can simulate a large number of AFS vectors (each resulting from a different assumed <span class="math inline">\(N_e\)</span> value) and then pick just those <span class="math inline">\(N_e\)</span> values (or just one <span class="math inline">\(N_e\)</span> value) which produced a simulated AFS closest to the observed AFS.</p>
<p>This is exactly what you’ll be doing just now in Exercise 3.</p>
<section id="part-1-a-self-contained-slendr-function-of-n_e-rightarrow-textrmafs" class="level2 page-columns page-full" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="part-1-a-self-contained-slendr-function-of-n_e-rightarrow-textrmafs"><span class="header-section-number">6.1</span> Part 1: A self-contained <em>slendr</em> function of <span class="math inline">\(N_e \rightarrow \textrm{AFS}\)</span></h2>
<p><strong>In a new script <code>exercise3.R</code> write a custom R function called <code>simulate_afs()</code>, which will take <code>Ne</code> as its only parameter. Use this function to compute (and return) <a href="https://en.wikipedia.org/wiki/Allele_frequency_spectrum">AFS vectors</a> for a couple of <code>Ne</code> values of your choosing, but staying between <code>Ne = 1000</code> and <code>Ne = 30000</code> Plot those AFS vectors and observe how (and why?) do they differ based on <code>Ne</code> parameter you used in each respective simulation.</strong></p>
<p><strong>Hint:</strong> The function should create a one-population <em>forward-time</em> model (our population starting at <code>time = 1</code>, with the model <code>simulation_length = 100000</code> and <code>generation_time = 1</code> in <code>compile_model()</code>), simulate 10Mb tree sequence using <code>msprime()</code> (recombination rate 1e-8) and then overlay neutral mutations on it at <code>mutation_rate = 1e-8</code>), compute AFS for 10 samples and return the AFS vector as result of this custom function.</p>
<p><strong>Hint:</strong> If you’ve never programmed before, the concept of a “custom function” might be very alien to you. Again, if you need help, feel free to start building your <code>exercise3.R</code> solution based on this “template” (just fill in missing relevant bits of <em>slendr</em> code that you should be already familiar with):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slendr)</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="fu">init_env</span>()</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>simulate_afs <span class="ot">&lt;-</span> <span class="cf">function</span>(Ne) {</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># In here you should write code which will:</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   1. create one population with a given Ne (provided as a function argument)</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   2. compile a model using `simulation_length =` and `generation_time =`</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   3. simulate a tree sequence</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   4. select names of 10 samples (doesn't matter which, "pop_1", "po2_", ...)</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   5. compute AFS vector from those 10 individuals using `ts_afs()`</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `result` is a variable with your 10-sample AFS vector (we remove the</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># first element because it's not meaningful for our example)</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result[<span class="sc">-</span><span class="dv">1</span>]) </span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>afs_1 <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="at">Ne =</span> <span class="dv">1000</span>) <span class="co"># simulate AFS from a Ne = 1000 model...</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(afs_1, <span class="at">type =</span><span class="st">"o"</span>)           <span class="co"># ... and plot it</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> Remember that you should drop the first element of the AFS vector produced by <code>ts_afs()</code> (for instance with something like <code>result[-1]</code> if <code>result</code> contains the output of <code>ts_afs()</code>) technical reasons related to <em>tskit</em>. You don’t have to worry about that here, but you can read <a href="https://tskit.dev/tutorials/analysing_tree_sequences.html#sec-tutorial-afs-zeroth-entry">this</a> for more detail.</p>
</div></div><p><strong>Hint:</strong> <strong>If the above still doesn’t make any sense to you, feel free to copy-paste the function from the solution below into your script and work with that function instead!</strong></p>
<p>When used in R, your custom function should work like this (the simulation is stochastic, so your numbers will be different, of course):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This gives us a vector of singletons, doubletons, etc., etc., all the way</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to the number of fixed mutations in our sample of 10 individuals</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="fu">simulate_afs</span>(<span class="at">Ne =</span> <span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 469 239 145  72  90  55  79  33  56  39  34  36  33  26  29  23  31  22  22
[20]   7</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># An R function can be understood as a block of a computer program which executes</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="co"># a block of code inside the {...} brackets given a certain value of a parameter</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (here 'Ne' just after the word 'function')</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>simulate_afs <span class="ot">&lt;-</span> <span class="cf">function</span>(Ne) {</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a slendr model with a single population of size Ne = N</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>  pop <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"pop"</span>, <span class="at">N =</span> Ne, <span class="at">time =</span> <span class="dv">1</span>)</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">compile_model</span>(pop, <span class="at">generation_time =</span> <span class="dv">1</span>, <span class="at">simulation_length =</span> <span class="dv">100000</span>)</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simulate a tree sequence</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>  ts <span class="ot">&lt;-</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> <span class="fl">10e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ts_mutate</span>(<span class="at">mutation_rate =</span> <span class="fl">1e-8</span>)</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get a random sample of names of 10 individuals</span></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>  samples <span class="ot">&lt;-</span> <span class="fu">ts_names</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">sample</span>(<span class="dv">10</span>)</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute the AFS vector (dropping the 0-th element added by tskit)</span></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>  afs <span class="ot">&lt;-</span> <span class="fu">ts_afs</span>(ts, <span class="at">sample_sets =</span> <span class="fu">list</span>(samples))[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>  afs</span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's use our custom function to simulate AFS vector for Ne = 1k, 10k, and 30k</span></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>afs_1k <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="dv">1000</span>)</span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>afs_10k <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="dv">10000</span>)</span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>afs_30k <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="dv">30000</span>)</span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the three simulated AFS using base R plotting functionality</span></span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(afs_30k, <span class="at">type =</span> <span class="st">"o"</span>, <span class="at">main =</span> <span class="st">"AFS, Ne = 30000"</span>, <span class="at">col =</span> <span class="st">"cyan"</span>,)</span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(afs_10k, <span class="at">type =</span> <span class="st">"o"</span>, <span class="at">main =</span> <span class="st">"AFS, Ne = 10000"</span>, <span class="at">col =</span> <span class="st">"purple"</span>)</span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(afs_1k, <span class="at">type =</span> <span class="st">"o"</span>, <span class="at">main =</span> <span class="st">"AFS, Ne = 1000"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Ne = 1k"</span>, <span class="st">"Ne = 10k"</span>, <span class="st">"Ne = 30k"</span>),</span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"purple"</span>, <span class="st">"cyan"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="part-2-estimating-unknown-n_e-from-empirical-afs" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="part-2-estimating-unknown-n_e-from-empirical-afs"><span class="header-section-number">6.2</span> Part 2: Estimating unknown <span class="math inline">\(N_e\)</span> from empirical AFS</h2>
<p>Imagine you sequenced 10 samples from a population and computed the following AFS vector (which contains, sequentially, the number of singletons, doubletons, etc., in your sample from a population):</p>
<!-- dput(as.vector(observed_afs)) -->
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>afs_observed <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2520</span>, <span class="dv">1449</span>, <span class="dv">855</span>, <span class="dv">622</span>, <span class="dv">530</span>, <span class="dv">446</span>, <span class="dv">365</span>, <span class="dv">334</span>, <span class="dv">349</span>, <span class="dv">244</span>,</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">264</span>, <span class="dv">218</span>,  <span class="dv">133</span>, <span class="dv">173</span>, <span class="dv">159</span>, <span class="dv">142</span>, <span class="dv">167</span>, <span class="dv">129</span>, <span class="dv">125</span>, <span class="dv">143</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You know (maybe from some fossil evidence) that the population probably had a constant <span class="math inline">\(N_e\)</span> somewhere between 1000 and 30000 for the past 100,000 generations, and had mutation and recombination rates of 1e-8 (i.e., parameters already implemented by your <code>simulate_afs()</code> function – how convenient!).</p>
<p><strong>Use <em>slendr</em> simulations to guess the true (and hidden!) <span class="math inline">\(N_e\)</span> given the observed AFS by running simulations for a range of <span class="math inline">\(N_e\)</span> values and finding out which <span class="math inline">\(N_e\)</span> produces the closest AFS vector to the <code>afs_observed</code> vector above using one of the following two approaches.</strong></p>
<ul>
<li><p><strong>Option 1</strong> [easy]: Plot AFS vectors for various <span class="math inline">\(N_e\)</span> values (i.e.&nbsp;simulate several of them using your function <code>simulate_afs()</code>), then eyeball which looks closest to the observed AFS based on the figures alone. (This is, of course, not how proper statistical inference is done, but it will be good enough for this exercie!)</p></li>
<li><p><strong>Option 2</strong> [hard]: Simulate AFS vectors in steps of possible <code>Ne</code> (maybe <code>lapply()</code>?), and find the <span class="math inline">\(N_e\)</span> which gives the closest AFS to the observed AFS based on <a href="https://en.wikipedia.org/wiki/Mean_squared_error">Mean squared error</a>.</p></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution to “Option 1”
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is our starting observed AFS which we want to compare simulated AFS vectors to</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>afs_observed <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2520</span>, <span class="dv">1449</span>, <span class="dv">855</span>, <span class="dv">622</span>, <span class="dv">530</span>, <span class="dv">446</span>, <span class="dv">365</span>, <span class="dv">334</span>, <span class="dv">349</span>, <span class="dv">244</span>,</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">264</span>, <span class="dv">218</span>,  <span class="dv">133</span>, <span class="dv">173</span>, <span class="dv">159</span>, <span class="dv">142</span>, <span class="dv">167</span>, <span class="dv">129</span>, <span class="dv">125</span>, <span class="dv">143</span>)</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We know that the Ne is between 1000 and 30000, so let's simulate</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a><span class="co"># a bunch of AFS vectors for different Ne values using our custom</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="co"># AFS simulation function</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>afs_Ne1k <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="at">Ne =</span> <span class="dv">1000</span>)</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>afs_Ne5k <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="at">Ne =</span> <span class="dv">5000</span>)</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>afs_Ne6k <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="at">Ne =</span> <span class="dv">6000</span>)</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>afs_Ne10k <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="at">Ne =</span> <span class="dv">10000</span>)</span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>afs_Ne20k <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="at">Ne =</span> <span class="dv">20000</span>)</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>afs_Ne30k <span class="ot">&lt;-</span> <span class="fu">simulate_afs</span>(<span class="at">Ne =</span> <span class="dv">30000</span>)</span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot all simulated AFS vectors, highlighting the observed AFS in black</span></span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(afs_observed, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">3</span>,</span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"allele count bin"</span>, <span class="at">ylab =</span> <span class="st">"count"</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">13000</span>))</span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(afs_Ne1k, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(afs_Ne5k, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"green"</span>)</span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(afs_Ne6k, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"pink"</span>)</span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(afs_Ne10k, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"purple"</span>)</span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(afs_Ne20k, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"orange"</span>)</span>
<span id="cb140-23"><a href="#cb140-23" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(afs_Ne30k, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"cyan"</span>)</span>
<span id="cb140-24"><a href="#cb140-24" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>,</span>
<span id="cb140-25"><a href="#cb140-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"observed AFS"</span>, <span class="st">"Ne = 1000"</span>, <span class="st">"Ne = 5000"</span>,</span>
<span id="cb140-26"><a href="#cb140-26" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Ne = 6000"</span>, <span class="st">"Ne = 10000"</span>, <span class="st">"Ne = 20000"</span>, <span class="st">"Ne = 30000"</span>),</span>
<span id="cb140-27"><a href="#cb140-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"blue"</span>, <span class="st">"green"</span>, <span class="st">"pink"</span>, <span class="st">"purple"</span>, <span class="st">"orange"</span>, <span class="st">"cyan"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!! SPOILER </span><span class="al">ALERT</span><span class="co"> BEFORE REVEALING THE CORRECT ANSWER !!!!!</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-34"><a href="#cb141-34" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-35"><a href="#cb141-35" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-36"><a href="#cb141-36" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-37"><a href="#cb141-37" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-38"><a href="#cb141-38" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-39"><a href="#cb141-39" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-40"><a href="#cb141-40" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-41"><a href="#cb141-41" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-42"><a href="#cb141-42" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-43"><a href="#cb141-43" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-44"><a href="#cb141-44" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-45"><a href="#cb141-45" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-46"><a href="#cb141-46" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-47"><a href="#cb141-47" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-48"><a href="#cb141-48" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb141-49"><a href="#cb141-49" aria-hidden="true" tabindex="-1"></a><span class="co"># true Ne was 6543!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution to “Option 2”
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is our starting observed AFS which we want to compare simulated AFS vectors to</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>afs_observed <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2520</span>, <span class="dv">1449</span>, <span class="dv">855</span>, <span class="dv">622</span>, <span class="dv">530</span>, <span class="dv">446</span>, <span class="dv">365</span>, <span class="dv">334</span>, <span class="dv">349</span>, <span class="dv">244</span>,</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">264</span>, <span class="dv">218</span>,  <span class="dv">133</span>, <span class="dv">173</span>, <span class="dv">159</span>, <span class="dv">142</span>, <span class="dv">167</span>, <span class="dv">129</span>, <span class="dv">125</span>, <span class="dv">143</span>)</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate regularly spaced values of potential Ne values (our parameter grid)</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>Ne_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">1000</span>, <span class="at">to =</span> <span class="dv">30000</span>, <span class="at">by =</span> <span class="dv">500</span>)</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>Ne_grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1000  1500  2000  2500  3000  3500  4000  4500  5000  5500  6000  6500
[13]  7000  7500  8000  8500  9000  9500 10000 10500 11000 11500 12000 12500
[25] 13000 13500 14000 14500 15000 15500 16000 16500 17000 17500 18000 18500
[37] 19000 19500 20000 20500 21000 21500 22000 22500 23000 23500 24000 24500
[49] 25000 25500 26000 26500 27000 27500 28000 28500 29000 29500 30000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I'm not entirely sure if your workshop cloud instances support big</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="co"># parallelization runs -- if not, you can modify the `mc.cores =` argument</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="co"># a couple of lines below to a smaller number (`mc.cores = 1` would make</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the simulation run on a single processor, i.e. no parallelization).</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute AFS (in parallel, to make things faster) across the entire grid of possible Ne values</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>afs_grid <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(Ne_grid, simulate_afs, <span class="at">mc.cores =</span> <span class="fu">detectCores</span>())</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(afs_grid) <span class="ot">&lt;-</span> Ne_grid</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the first five simulated AFS vectors, for brevity</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>afs_grid[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$`1000`
 [1] 400 201 142  94  83  43  46  51  50  27  78  47  24  27  42  12  29  20  10
[20]  23

$`1500`
 [1] 582 277 209 128  85 107  99  59  62  71  56  52  50  40  36  29  49  30  31
[20]  35

$`2000`
 [1] 901 403 241 227 148 149 115 122 108  79  84  77  70  65  52  56  37  46  25
[20]  18

$`2500`
 [1] 900 486 349 293 184 157 135 153 118  91 111 111  78  72  94  69  80  59  46
[20]  78

$`3000`
 [1] 1144  531  409  331  243  188  171  128  170  122  133  102   87  122  105
[16]   96   70   50   55   53</code></pre>
</div>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the observed AFS...</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(afs_observed, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">xlab =</span> <span class="st">"allele count bin"</span>, <span class="at">ylab =</span> <span class="st">"count"</span>)</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ... and overlay the simulated AFS vectors on top of it</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(Ne_grid)) {</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(afs_grid[[i]], <span class="at">lwd =</span> <span class="fl">0.5</span>)</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"observed AFS"</span>, <span class="st">"simulated AFS"</span>), <span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"gray"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute mean-squared error of the AFS produced by each Ne value across the grid</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>errors <span class="ot">&lt;-</span> <span class="fu">sapply</span>(afs_grid, <span class="cf">function</span>(sim_afs) {</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>((sim_afs <span class="sc">-</span> afs_observed)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">length</span>(sim_afs)</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Ne_grid, errors, <span class="at">ylab =</span> <span class="st">"error"</span>)</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> Ne_grid[<span class="fu">which.min</span>(errors)], <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"minimum error Ne ="</span>, Ne_grid[<span class="fu">which.min</span>(errors)]), <span class="at">fill =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-43-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the AFS again, but this time highlight the most likely spectrum</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (i.e. the one which gave the lowest RMSE value)</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(afs_observed, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">xlab =</span> <span class="st">"allele count bin"</span>, <span class="at">ylab =</span> <span class="st">"count"</span>)</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(Ne_grid)) {</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>  color <span class="ot">&lt;-</span> <span class="cf">if</span> (i <span class="sc">==</span> <span class="fu">which.min</span>(errors)) <span class="st">"red"</span> <span class="cf">else</span> <span class="st">"gray"</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>  width <span class="ot">&lt;-</span> <span class="cf">if</span> (i <span class="sc">==</span> <span class="fu">which.min</span>(errors)) <span class="dv">2</span> <span class="cf">else</span> <span class="fl">0.75</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(afs_grid[[i]], <span class="at">lwd =</span> width, <span class="at">col =</span> color)</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"observed AFS"</span>, <span class="fu">paste</span>(<span class="st">"best fitting Ne ="</span>, Ne_grid[<span class="fu">which.min</span>(errors)])),</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-43-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!! SPOILER </span><span class="al">ALERT</span><span class="co"> BEFORE REVEALING THE CORRECT ANSWER !!!!!</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-26"><a href="#cb149-26" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-27"><a href="#cb149-27" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-28"><a href="#cb149-28" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-29"><a href="#cb149-29" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-30"><a href="#cb149-30" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-31"><a href="#cb149-31" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-32"><a href="#cb149-32" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-33"><a href="#cb149-33" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-34"><a href="#cb149-34" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-35"><a href="#cb149-35" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-36"><a href="#cb149-36" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-37"><a href="#cb149-37" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-38"><a href="#cb149-38" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-39"><a href="#cb149-39" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-40"><a href="#cb149-40" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-41"><a href="#cb149-41" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-42"><a href="#cb149-42" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-43"><a href="#cb149-43" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-44"><a href="#cb149-44" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-45"><a href="#cb149-45" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-46"><a href="#cb149-46" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-47"><a href="#cb149-47" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-48"><a href="#cb149-48" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb149-49"><a href="#cb149-49" aria-hidden="true" tabindex="-1"></a><span class="co"># true Ne was 6543!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Congratulations, you now know how to infer parameters of evolutionary models using simulations! What you just did is really very similar to how simulation-based inference is done in practice (even with methods such as ABC). Hopefully you can also see how easy does <em>slendr</em> make it.</p>
<p>This kind of approach can be used to infer all sorts of demographic parameters, even using other summary statistics that you’ve also learned to compute… including selection parameters, which we delve into in the next exercise.</p>
</section>
</section>
<section id="simulating-and-detecting-natural-selection" class="level1 page-columns page-full" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Simulating (and detecting) natural selection</h1>
<p>The primary motivation for designing <em>slendr</em> was to make demographic modelling in R as trivially easy and fast as possible, focusing exclusively on neutral models. However, as <em>slendr</em> became popular, people have been asking for the possibility of simulating natural selection. After all, a large part of <em>slendr</em>’s functionality deals with population genetic <a href="https://www.slendr.net/articles/vignette-06-locations.html">models across geographical landscapes</a>, which requires SLiM. So why not support selection simulations using <em>slendr</em> as well?</p>
<p>In December 2024 I caved in and added support for modifying <em>slendr</em> demographic models with bits of SLiM code, which allows simulating pretty much any arbitrary selection scenario you might be interested in.</p>
<p>This exercise is a quick demonstration of how this works and how you might simulate selection using <em>slendr</em>. We will do this using another toy model of ancient human history, which we will first use as a basis for simulating the frequency trajectory of an allele under positive selection, and then implementing a toy selection scan using Tajima’s D.</p>
<p>To speed things up, <strong>create a new <code>exercise4.R</code> script and copy the following code as a starting point for this exercise</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slendr)</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="fu">init_env</span>(<span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This line sources a script in which I provide a few useful helper functions</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="co"># which you can use in this exercise</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"utils.R"</span>))</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="co"># African ancestral population</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>afr <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"AFR"</span>, <span class="at">time =</span> <span class="dv">65000</span>, <span class="at">N =</span> <span class="dv">5000</span>)</span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="co"># First migrants out of Africa</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>ooa <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"OOA"</span>, <span class="at">parent =</span> afr, <span class="at">time =</span> <span class="dv">60000</span>, <span class="at">N =</span> <span class="dv">5000</span>, <span class="at">remove =</span> <span class="dv">27000</span>)</span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Eastern hunter-gatherers</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>ehg <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"EHG"</span>, <span class="at">parent =</span> ooa, <span class="at">time =</span> <span class="dv">28000</span>, <span class="at">N =</span> <span class="dv">5000</span>, <span class="at">remove =</span> <span class="dv">6000</span>)</span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a><span class="co"># European population</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>eur <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"EUR"</span>, <span class="at">parent =</span> ehg, <span class="at">time =</span> <span class="dv">25000</span>, <span class="at">N =</span> <span class="dv">5000</span>)</span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Anatolian farmers</span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>ana <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"ANA"</span>, <span class="at">time =</span> <span class="dv">28000</span>, <span class="at">N =</span> <span class="dv">5000</span>, <span class="at">parent =</span> ooa, <span class="at">remove =</span> <span class="dv">4000</span>)</span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Yamnaya steppe population</span></span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>yam <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"YAM"</span>, <span class="at">time =</span> <span class="dv">8000</span>, <span class="at">N =</span> <span class="dv">5000</span>, <span class="at">parent =</span> ehg, <span class="at">remove =</span> <span class="dv">2500</span>)</span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Define gene-flow events</span></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>gf <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gene_flow</span>(<span class="at">from =</span> ana, <span class="at">to =</span> yam, <span class="at">rate =</span> <span class="fl">0.75</span>, <span class="at">start =</span> <span class="dv">7500</span>, <span class="at">end =</span> <span class="dv">6000</span>),</span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gene_flow</span>(<span class="at">from =</span> ana, <span class="at">to =</span> eur, <span class="at">rate =</span> <span class="fl">0.5</span>, <span class="at">start =</span> <span class="dv">6000</span>, <span class="at">end =</span> <span class="dv">5000</span>),</span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gene_flow</span>(<span class="at">from =</span> yam, <span class="at">to =</span> eur, <span class="at">rate =</span> <span class="fl">0.6</span>, <span class="at">start =</span> <span class="dv">4000</span>, <span class="at">end =</span> <span class="dv">3500</span>)</span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb150-32"><a href="#cb150-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-33"><a href="#cb150-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile all populations into a single slendr model object</span></span>
<span id="cb150-34"><a href="#cb150-34" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">compile_model</span>(</span>
<span id="cb150-35"><a href="#cb150-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">populations =</span> <span class="fu">list</span>(afr, ooa, ehg, eur, ana, yam),</span>
<span id="cb150-36"><a href="#cb150-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">gene_flow =</span> gf, <span class="at">generation_time =</span> <span class="dv">30</span></span>
<span id="cb150-37"><a href="#cb150-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb150-38"><a href="#cb150-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-39"><a href="#cb150-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Schedule the sampling from four European populations roughly before their</span></span>
<span id="cb150-40"><a href="#cb150-40" aria-hidden="true" tabindex="-1"></a><span class="co"># disappearance (or before the end of the simulation)</span></span>
<span id="cb150-41"><a href="#cb150-41" aria-hidden="true" tabindex="-1"></a>schedule <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb150-42"><a href="#cb150-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="dv">0</span>, <span class="fu">list</span>(eur, <span class="dv">50</span>)),</span>
<span id="cb150-43"><a href="#cb150-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="dv">6000</span>, <span class="fu">list</span>(ehg, <span class="dv">50</span>)),</span>
<span id="cb150-44"><a href="#cb150-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="dv">4000</span>, <span class="fu">list</span>(ana, <span class="dv">50</span>)),</span>
<span id="cb150-45"><a href="#cb150-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="dv">2500</span>, <span class="fu">list</span>(yam, <span class="dv">50</span>))</span>
<span id="cb150-46"><a href="#cb150-46" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Next, visualize the demographic model.</strong> If you did a bit of work in human population genetics, you might recognize it as a very simplified model of demographic history of Europe over the past 50 thousand years or so. As you can see, we are recording 50 individuals from four populations – for Europeans we sample 50 individuals at “present-day”, for the remaining populations we’re recording 50 individuals just before their disappearance. Also note that there’s quite a bit of gene-flow! This was an important thing we’ve learned about human history in the past 10 years or so – everyone is mixed with pretty much everyone, there isn’t (and never was) anything as a “pure population”.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> We didn’t discuss it earlier, but <em>slendr</em> also provides the option to specify a <code>remove =</code> argument in a <code>population()</code> call which instructs the simulation engine to delete a population from a simulation at a given point. For our <code>msprime()</code> simulations in earlier examples it wasn’t really important, but for the <code>slim()</code> simulation we will be running below, we want to make a population extinct at a certain timepoint. Which is why our ancient populations in the starting script model have the <code>remove =</code> parameter specified.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model, <span class="at">proportions =</span> <span class="cn">TRUE</span>, <span class="at">samples =</span> schedule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<section id="part-1-simulating-a-tree-sequence-and-computing-tajimas-d" class="level3" data-number="7.0.1">
<h3 data-number="7.0.1" class="anchored" data-anchor-id="part-1-simulating-a-tree-sequence-and-computing-tajimas-d"><span class="header-section-number">7.0.1</span> Part 1: Simulating a tree sequence and computing Tajima’s D</h3>
<p>Although the point of this exercise is to simulate selection, let’s first simulate a normal neutral model using slendr’s <code>msprime()</code> engine as a sanity check. <strong>Simulate 10 Mb of sequence with a recombination rate <code>1e-8</code> and a sampling <code>schedule</code> defined above.</strong> Let’s not worry about adding any mutations, just to change things up a little bit. We’ll be working with branch-based statistics here (which means adding <code>mode = "branch"</code> whenever we will be computing a statistic, such as Tajima’s D).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> <span class="fl">10e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>, <span class="at">samples =</span> schedule)</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>ts <span class="co"># no mutations!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>╔═══════════════════════════╗
║TreeSequence               ║
╠═══════════════╤═══════════╣
║Trees          │      19079║
╟───────────────┼───────────╢
║Sequence Length│   10000000║
╟───────────────┼───────────╢
║Time Units     │generations║
╟───────────────┼───────────╢
║Sample Nodes   │        400║
╟───────────────┼───────────╢
║Total Size     │    3.8 MiB║
╚═══════════════╧═══════════╝
╔═══════════╤═════╤═════════╤════════════╗
║Table      │Rows │Size     │Has Metadata║
╠═══════════╪═════╪═════════╪════════════╣
║Edges      │82712│  2.5 MiB│          No║
╟───────────┼─────┼─────────┼────────────╢
║Individuals│  200│  5.5 KiB│          No║
╟───────────┼─────┼─────────┼────────────╢
║Migrations │    0│  8 Bytes│          No║
╟───────────┼─────┼─────────┼────────────╢
║Mutations  │    0│ 16 Bytes│          No║
╟───────────┼─────┼─────────┼────────────╢
║Nodes      │22453│614.0 KiB│          No║
╟───────────┼─────┼─────────┼────────────╢
║Populations│    6│417 Bytes│         Yes║
╟───────────┼─────┼─────────┼────────────╢
║Provenances│    1│  3.6 KiB│          No║
╟───────────┼─────┼─────────┼────────────╢
║Sites      │    0│ 16 Bytes│          No║
╚═══════════╧═════╧═════════╧════════════╝</code></pre>
</div>
</div>
</div>
</div>
</div>
<p><strong>Inspect the table of all individuals recorded in our tree sequence using the function <code>ts_samples()</code>, making sure we have all the individuals scheduled for tree-sequence recording.</strong> (Again, there’s no such a thing as too many sanity checks when doing research!)</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-26-contents" aria-controls="callout-26" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-26" class="callout-26-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 200 × 3
   name    time pop  
   &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;
 1 EHG_1   6000 EHG  
 2 EHG_2   6000 EHG  
 3 EHG_3   6000 EHG  
 4 EHG_4   6000 EHG  
 5 EHG_5   6000 EHG  
 6 EHG_6   6000 EHG  
 7 EHG_7   6000 EHG  
 8 EHG_8   6000 EHG  
 9 EHG_9   6000 EHG  
10 EHG_10  6000 EHG  
# ℹ 190 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(pop, time) <span class="sc">%&gt;%</span> tally</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   pop [4]
  pop    time     n
  &lt;chr&gt; &lt;dbl&gt; &lt;int&gt;
1 ANA    4000    50
2 EHG    6000    50
3 EUR       0    50
4 YAM    2500    50</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>As you’ve already learned in an earlier exercise, <em>tskit</em> functions in <em>slendr</em> generally operate on vectors (or lists) of individual names, like those produced by <code>ts_names()</code> above. <strong>Get a vector of names of individuals in every population recorded in the tree sequence, then use this to compute Tajima’s D using the <em>slendr</em> function <code>ts_tajima()</code>.</strong> (Use the same approach as you have with <code>ts_diversity()</code> or <code>ts_divergence()</code> above, using the list of names of individuals as the <code>sample_sets =</code> argument for <code>ts_tajima()</code>). <strong>Do you see any striking differences in the Tajima’s D values across populations? Check <a href="https://en.wikipedia.org/wiki/Tajima%27s_D#Interpreting_Tajima's_D">this</a> for some general guidance.</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-27-contents" aria-controls="callout-27" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-27" class="callout-27-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">ts_names</span>(ts, <span class="at">split =</span> <span class="st">"pop"</span>)</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$ANA
 [1] "ANA_1"  "ANA_2"  "ANA_3"  "ANA_4"  "ANA_5"  "ANA_6"  "ANA_7"  "ANA_8" 
 [9] "ANA_9"  "ANA_10" "ANA_11" "ANA_12" "ANA_13" "ANA_14" "ANA_15" "ANA_16"
[17] "ANA_17" "ANA_18" "ANA_19" "ANA_20" "ANA_21" "ANA_22" "ANA_23" "ANA_24"
[25] "ANA_25" "ANA_26" "ANA_27" "ANA_28" "ANA_29" "ANA_30" "ANA_31" "ANA_32"
[33] "ANA_33" "ANA_34" "ANA_35" "ANA_36" "ANA_37" "ANA_38" "ANA_39" "ANA_40"
[41] "ANA_41" "ANA_42" "ANA_43" "ANA_44" "ANA_45" "ANA_46" "ANA_47" "ANA_48"
[49] "ANA_49" "ANA_50"

$EHG
 [1] "EHG_1"  "EHG_2"  "EHG_3"  "EHG_4"  "EHG_5"  "EHG_6"  "EHG_7"  "EHG_8" 
 [9] "EHG_9"  "EHG_10" "EHG_11" "EHG_12" "EHG_13" "EHG_14" "EHG_15" "EHG_16"
[17] "EHG_17" "EHG_18" "EHG_19" "EHG_20" "EHG_21" "EHG_22" "EHG_23" "EHG_24"
[25] "EHG_25" "EHG_26" "EHG_27" "EHG_28" "EHG_29" "EHG_30" "EHG_31" "EHG_32"
[33] "EHG_33" "EHG_34" "EHG_35" "EHG_36" "EHG_37" "EHG_38" "EHG_39" "EHG_40"
[41] "EHG_41" "EHG_42" "EHG_43" "EHG_44" "EHG_45" "EHG_46" "EHG_47" "EHG_48"
[49] "EHG_49" "EHG_50"

$EUR
 [1] "EUR_1"  "EUR_2"  "EUR_3"  "EUR_4"  "EUR_5"  "EUR_6"  "EUR_7"  "EUR_8" 
 [9] "EUR_9"  "EUR_10" "EUR_11" "EUR_12" "EUR_13" "EUR_14" "EUR_15" "EUR_16"
[17] "EUR_17" "EUR_18" "EUR_19" "EUR_20" "EUR_21" "EUR_22" "EUR_23" "EUR_24"
[25] "EUR_25" "EUR_26" "EUR_27" "EUR_28" "EUR_29" "EUR_30" "EUR_31" "EUR_32"
[33] "EUR_33" "EUR_34" "EUR_35" "EUR_36" "EUR_37" "EUR_38" "EUR_39" "EUR_40"
[41] "EUR_41" "EUR_42" "EUR_43" "EUR_44" "EUR_45" "EUR_46" "EUR_47" "EUR_48"
[49] "EUR_49" "EUR_50"

$YAM
 [1] "YAM_1"  "YAM_2"  "YAM_3"  "YAM_4"  "YAM_5"  "YAM_6"  "YAM_7"  "YAM_8" 
 [9] "YAM_9"  "YAM_10" "YAM_11" "YAM_12" "YAM_13" "YAM_14" "YAM_15" "YAM_16"
[17] "YAM_17" "YAM_18" "YAM_19" "YAM_20" "YAM_21" "YAM_22" "YAM_23" "YAM_24"
[25] "YAM_25" "YAM_26" "YAM_27" "YAM_28" "YAM_29" "YAM_30" "YAM_31" "YAM_32"
[33] "YAM_33" "YAM_34" "YAM_35" "YAM_36" "YAM_37" "YAM_38" "YAM_39" "YAM_40"
[41] "YAM_41" "YAM_42" "YAM_43" "YAM_44" "YAM_45" "YAM_46" "YAM_47" "YAM_48"
[49] "YAM_49" "YAM_50"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute genome-wide Tajima's D for each population -- note that we don't</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="co"># expect to see any significant differences because no population experienced</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="co"># natural selection (yet)</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_tajima</span>(ts, <span class="at">sample_sets =</span> samples, <span class="at">mode =</span> <span class="st">"branch"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  set         D
  &lt;chr&gt;   &lt;dbl&gt;
1 ANA    0.0580
2 EHG    0.0232
3 EUR   -0.466 
4 YAM   -0.353 </code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="part-2-computing-tajimas-d-in-windows" class="level2 page-columns page-full" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="part-2-computing-tajimas-d-in-windows"><span class="header-section-number">7.1</span> Part 2: Computing Tajima’s D in windows</h2>
<p>Let’s take this one step forward. Even if there is a locus under positive selection somewhere along our chromosome, it might be quite unlikely that we would find a Tajima’s D value significant enough for the entire chromosome (which is basically what we did in Part 1 now). Fortunately, thanks to the flexibility of the <em>tskit</em> module, the <em>slendr</em> function <code>ts_tajima()</code> has an argument <code>windows =</code>, which allows us to specify the coordinates of windows into which a sequence should be broken into, with Tajima’s D computed separately for each window. Perhaps this will allow us to see the impact of positive selection after we get to adding selection to our model. So let’s first built some code towards that.</p>
<p><strong>Define a variable <code>windows</code> which will contain a vector of coordinates of 100 windows, starting at position <code>0</code>, and ending at position <code>10e6</code> (i.e., the end of our chromosome). Then provide this variable as the <code>windows =</code> argument of <code>ts_tajima()</code> on a new, separate line of your script. Save the result of <code>ts_tajima()</code> into the variable <code>tajima_wins</code>, and inspect its contents in the R console.</strong></p>
<p><strong>Hint:</strong> You can use the R function <code>seq()</code> and its argument <code>length.out = 100</code>, to create the coordinates of window boundaries very easily.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-28-contents" aria-controls="callout-28" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-28" class="callout-28-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-compute genomic windows for window-based computation of Tajima's D</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>windows <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">seq</span>(<span class="dv">0</span>, ts<span class="sc">$</span>sequence_length, <span class="at">length.out =</span> <span class="dv">100</span>))</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>windows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1]        0   101010   202020   303030   404040   505051   606061   707071
  [9]   808081   909091  1010101  1111111  1212121  1313131  1414141  1515152
 [17]  1616162  1717172  1818182  1919192  2020202  2121212  2222222  2323232
 [25]  2424242  2525253  2626263  2727273  2828283  2929293  3030303  3131313
 [33]  3232323  3333333  3434343  3535354  3636364  3737374  3838384  3939394
 [41]  4040404  4141414  4242424  4343434  4444444  4545455  4646465  4747475
 [49]  4848485  4949495  5050505  5151515  5252525  5353535  5454545  5555556
 [57]  5656566  5757576  5858586  5959596  6060606  6161616  6262626  6363636
 [65]  6464646  6565657  6666667  6767677  6868687  6969697  7070707  7171717
 [73]  7272727  7373737  7474747  7575758  7676768  7777778  7878788  7979798
 [81]  8080808  8181818  8282828  8383838  8484848  8585859  8686869  8787879
 [89]  8888889  8989899  9090909  9191919  9292929  9393939  9494949  9595960
 [97]  9696970  9797980  9898990 10000000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute genome-wide Tajima's D for each population in individual windows</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>tajima_wins <span class="ot">&lt;-</span> <span class="fu">ts_tajima</span>(ts, <span class="at">sample_sets =</span> samples, <span class="at">windows =</span> windows, <span class="at">mode =</span> <span class="st">"branch"</span>)</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>tajima_wins</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  set   D           
  &lt;chr&gt; &lt;named list&gt;
1 ANA   &lt;dbl [99]&gt;  
2 EHG   &lt;dbl [99]&gt;  
3 EUR   &lt;dbl [99]&gt;  
4 YAM   &lt;dbl [99]&gt;  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co"># You can see that the format of the result is slightly strange, with the</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="co"># `D` column containing a vector of numbers (this is done for conciseness)</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>tajima_wins[<span class="dv">1</span>, ]<span class="sc">$</span>D</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$`1`
 [1] -0.354052781 -0.342234459 -0.320076563 -0.208345083 -0.214277121
 [6] -0.017410189  0.153475629  0.387428485 -0.604691355 -0.542330657
[11] -1.145804785 -0.929691760 -0.261087283 -0.893985513 -0.564595982
[16] -0.497985165  0.817020892  0.019905178  0.206515500 -0.070682044
[21]  0.013106622  0.675539095  0.995186061  0.262902685  0.353138615
[26]  0.509580056  0.639291336  0.506034938  0.519200168  0.539439339
[31]  0.079918322 -0.496792922  0.037375468  0.356119867  0.187179758
[36] -0.119735709  0.577887619 -0.167904757  0.522701233  0.994999304
[41] -0.703582478  0.054484727  0.436895752  0.028084661  0.079644267
[46]  0.261625680  0.354236197 -0.355852685 -0.307391927 -0.078129710
[51]  0.414472155  0.299468217  0.007732445 -0.138999763 -0.832174012
[56] -0.569876014  0.530202607  0.552641582  1.081278415 -0.609719673
[61]  0.251031212 -0.160821936  0.499212041  0.367495799  0.048099542
[66] -0.524380857 -0.272383846 -0.424152611  0.263468151  0.331509596
[71] -0.393069200 -0.353212137 -0.027107870  0.262984836 -0.015731247
[76] -0.379056255  0.437148230 -0.575120130 -0.215921271  0.273532090
[81]  0.295956346 -0.270489281 -0.312602435  0.117673002  0.046238996
[86] -0.005016429  0.242742858  0.855901479 -0.242284392  0.254459114
[91] -0.015718550 -0.448790199  0.748019967  0.334046719  0.308808659
[96] -0.025052504  0.289518111 -0.600932450 -0.112794704</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>The default output format of <code>ts_tajima()</code> is not super user-friendly. <strong>Process the result using a helper function <code>process_tajima(tajima_wins)</code> that I provided for you (perhaps save it as <code>tajima_df</code>), and visualize it using another of my helper functions <code>plot_tajima(tajima_df)</code>.</strong></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> Making the <code>process_tajima()</code> and <code>plot_tajima()</code> function available in your R code is the purpose of the <code>source(here::here("utils.R"))</code> command at the beginning of your script for this exercise.</p>
</div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-29-contents" aria-controls="callout-29" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-29" class="callout-29-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The helper function `process_tajima()` reformats the results into a normal</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="co"># data frame, this time with a new column `window` which indicates the index</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="co"># of the window that each `D` value was computed in</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>tajima_df <span class="ot">&lt;-</span> <span class="fu">process_tajima</span>(tajima_wins)</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>tajima_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 396 × 3
   set         D window
   &lt;chr&gt;   &lt;dbl&gt;  &lt;int&gt;
 1 ANA   -0.354       1
 2 ANA   -0.342       2
 3 ANA   -0.320       3
 4 ANA   -0.208       4
 5 ANA   -0.214       5
 6 ANA   -0.0174      6
 7 ANA    0.153       7
 8 ANA    0.387       8
 9 ANA   -0.605       9
10 ANA   -0.542      10
# ℹ 386 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's visualize the window-based Tajima's D along the simulated genome</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="co"># using another helper function `plot_tajima()`</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_tajima</span>(tajima_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It’s no surprise that we don’t see any Tajima’s D outliers in any of our windows, because we’re still working with a tree sequence produced by our a purely neutral simulation. But we have everything set up for the next part, in which we will add selection acting on a beneficial allele.</p>
</div>
</div>
</div>
</section>
<section id="part-3-adding-positive-selection-to-the-base-demographic-model" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="part-3-adding-positive-selection-to-the-base-demographic-model"><span class="header-section-number">7.2</span> Part 3: Adding positive selection to the base demographic model</h2>
<p>Although primarily designed for neutral demographic models, <em>slendr</em> allows optional simulation of natural selection by providing a “SLiM extension code snippet” with customization SLiM code as an optional argument <code>extension =</code> of <code>compile_model()</code> (a function you’re closely familiar with at this point).</p>
<p>Unfortunately we don’t have any space to explain SLiM here (and I have no idea, at the time of writing, whether or not you will have worked with SLiM earlier in this workshop). Suffice to say that SLiM is another very popular population genetic simulator software which allows simulation of selection, and which requires you to write custom code in a different programming language called Eidos.</p>
<p><strong>Take a look at the file <code>slim_extension.txt</code> provided in your working directory (it’s also part of the GitHub repository <a href="https://github.com/bodkan/simgen/blob/main/slim_extension.txt">here</a>). If you worked with SLiM before, glance through the script casually and see if it makes any sense to you. If you have not worked with SLiM before, look for the strange <code>{elements}</code> in curly brackets in the first ten lines of the script.</strong> Those are the parameters of the selection model we will be customizing the standard neutral demographic model we started with in the next step.</p>
<p>Specifically, when you inspect the <code>slim_extension.txt</code> file, you can see that this “SLiM extension script” I provided for you has three parameters:</p>
<ul>
<li><code>origin_pop</code> – in which population should a beneficial allele appear,</li>
<li><code>s</code> – what should be the selection coefficient of the beneficial allele, and</li>
<li><code>onset_time</code> – at which time should the allele appear in the <code>origin_pop</code>.</li>
</ul>
<p>However, at the start, the SLiM extension snippet doesn’t contain any concrete values of those parameters, but only their <code>{origin_pop}</code>, <code>{s}</code>, and <code>{onset_time}</code> placeholders.</p>
<p><strong>Use the <em>slendr</em> function <code>substitute_values()</code> to substitute concrete values for those parameters like this:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>extension <span class="ot">&lt;-</span> <span class="fu">substitute_values</span>(</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">template =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"slim_extension.txt"</span>),</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">origin_pop =</span> <span class="st">"EUR"</span>,</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">s =</span> <span class="fl">0.15</span>,</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">onset_time =</span> <span class="dv">12000</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>extension</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/var/folders/70/b_q2zdh116b9pfg29p03sx600000gn/T//RtmpWLi9I5/filed445c8804a8"</code></pre>
</div>
</div>
<p>You can see that <code>substitute_values()</code> returned a path to a file. <strong>Take a look at that file in your terminal – you should see each of the three <code>{placeholder}</code> parameters replaced with a concrete given value.</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-30-contents" aria-controls="callout-30" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-30" class="callout-30-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Let’s take a look at the first 15 lines of the extension file before and after calling <code>substitute_values()</code>. We’ll do this in R for simplicity, but you can use <code>less</code> in plain unix terminal.</p>
<p><strong>Before – see the {{placeholder}} parameters in their original form:</strong></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>// Define model constants (to be substituted) all in one place
// (each {{placeholder}} will be replaced by a value passed from R).
// Note that string constant template patterns are surrounded by "quotes"!
initialize() {
    defineConstant("s", {{s}});
    defineConstant("onset_time", {{onset_time}});
    defineConstant("origin_pop", "{{origin_pop}}");

    // compose a trajectory file based on given parameters
    defineConstant("traj_file", PATH + "/" + "trajectory.tsv");
}</code></pre>
</div>
</div>
<p><strong>After – see the {{placeholder}} parameters with concrete values!</strong></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>// Define model constants (to be substituted) all in one place
// (each {{placeholder}} will be replaced by a value passed from R).
// Note that string constant template patterns are surrounded by "quotes"!
initialize() {
    defineConstant("s", 0.15);
    defineConstant("onset_time", 12000);
    defineConstant("origin_pop", "EUR");

    // compose a trajectory file based on given parameters
    defineConstant("traj_file", PATH + "/" + "trajectory.tsv");
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>And that’s all the extra work we need to turn our purely neutral demographic <em>slendr</em> model into a model which includes natural selection! (In this case, only a simple selection acting on a single locus, as you’ll see later, but this can be generalized to any imaginable selection scenario.)</p>
<p>How do we use the SLiM extension for our simulation? It’s very simple – we just have to provide the <code>extension</code> variable as an additional argument of good old <code>compile_model()</code>. This will compile a new <em>slendr</em> model which will now include the new functionality for simulating natural selection:</p>
<p><strong>Compile a new <code>model</code> of the history of populations <code>afr</code>, <code>ooa</code>, <code>ehg</code>, etc., by following the instructions above, providing a new <code>extension =</code> argument to the <code>compile_model()</code> function.</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-31-contents" aria-controls="callout-31" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-31" class="callout-31-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">compile_model</span>(</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">populations =</span> <span class="fu">list</span>(afr, ooa, ehg, eur, ana, yam),</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">gene_flow =</span> gf, <span class="at">generation_time =</span> <span class="dv">30</span>,</span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">extension =</span> extension   <span class="co"># &lt;======== this is missing in the neutral example!</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="part-4-running-a-selection-simulation-using-slim" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="part-4-running-a-selection-simulation-using-slim"><span class="header-section-number">7.3</span> Part 4: Running a selection simulation using <code>slim()</code></h2>
<p>Now we can finally run our selection simulation!</p>
<p>There are two modifications to our previous simulation workflows:</p>
<ol type="1">
<li>Because we need to run a non-neutral simulation, we have to switch from using the <code>msprime()</code> <em>slendr</em> engine to <code>slim()</code>. The latter can still interpret the same demographic model we programmed in R, just like the <code>msprime()</code> engine can, but will run the model using SLiM (and thus leveraging the new SLiM extension code that we have customized using <code>substitute_values()</code> above). We simply do this by switching from this:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> <span class="fl">10e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>, <span class="at">samples =</span> schedule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>to this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">slim</span>(model, <span class="at">sequence_length =</span> <span class="fl">10e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>, <span class="at">samples =</span> schedule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see, you don’t have to modify anything in your model code, just switching from <code>msprime</code> to <code>slim</code> in the line of code which produces the simulation result.</p>
<ol start="2" type="1">
<li>The customized model will not only produce a tree sequence, but will also generate a table of allele frequencies in each population (SLiM experts might have noticed the revelant SLiM code when they were inspecting <a href="https://github.com/bodkan/simgen/blob/main/slim_extension.txt"><code>slim_extension.txt</code></a>). We need to be able to load both of these files after the simulation and thus need a path to a location we can find those files. We can do this by calling the <code>slim()</code> function as <code>path &lt;- slim(..., path = TRUE)</code> (so with the extra <code>path =</code> argument). This will return a path to where the <code>slim()</code> engine saved all files with our desired results.</li>
</ol>
<p><strong>Run a simulation from the modified model of selection with the <code>slim()</code> engine as instructed in points number 1. and 2. above, then use the <code>list.files(path)</code> function in R to take a look in the directory. Which files were produced by the simulation?</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-32-contents" aria-controls="callout-32" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution (you have a working SLiM installation)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-32" class="callout-32-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tstart &lt;- Sys.time()</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="fu">slim</span>(model, <span class="at">sequence_length =</span> <span class="fl">10e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>, <span class="at">samples =</span> schedule, <span class="at">path =</span> <span class="cn">TRUE</span>, <span class="at">random_seed =</span> <span class="dv">59879916</span>)</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="co"># tend &lt;- Sys.time()</span></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a><span class="co"># tend - tstart # Time difference of 38.82014 secs</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a><span class="co"># We can verify that the path not only contains a tree-sequence file but also</span></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a><span class="co"># the table of allele frequencies.</span></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "slim.trees"     "trajectory.tsv"</code></pre>
</div>
</div>
<p>We can see that the <code>slim()</code> simulation generated a tree-sequence file (just like in previous exercises focused on <code>msprime()</code>) but it also created a new file – this was done by the SLiM customization snippet we provided to <code>compile_model()</code>.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-33-contents" aria-controls="callout-33" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution (you don’t have a working SLiM installation <em>or</em> the simulation takes too long)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-33" class="callout-33-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If you don't have SLiM set up, just use the simulated results from my own</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="co"># run of the same simulation</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/selection"</span>)</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We can verify that the path not only contains a tree-sequence file but also</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the table of allele frequencies.</span></span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "slim.trees"     "trajectory.tsv"</code></pre>
</div>
</div>
<p>We can see that the <code>slim()</code> simulation generated a tree-sequence file (just like in previous exercises focused on <code>msprime()</code>) but it also created a new file – this was done by the SLiM customization snippet we provided to <code>compile_model()</code>.</p>
</div>
</div>
</div>
</section>
<section id="part-5-investigating-allele-frequency-trajectories" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="part-5-investigating-allele-frequency-trajectories"><span class="header-section-number">7.4</span> Part 5: Investigating allele frequency trajectories</h2>
<p><strong>Use another helper function <code>read_trajectory(path)</code> which I provided for this exercise to read the simulated frequency trajectories of the positively selected mutation in all of our populations into a variable <code>traj_df</code>. Then run a second helper function <code>plot_trajectory(traj_df)</code> to inspect the trajectories visually.</strong></p>
<p><strong>Recall that you used the function <code>substitute_values()</code> to parametrize your selection model so that the allele under selection occurs in Europeans 15 thousand years ago, and is programmed to be under very strong selection of <span class="math inline">\(s = 0.15\)</span>. Do the trajectories visualized by <code>plot_trajectory()</code> make sense given the demographic model of European prehistory plotted above?</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-34-contents" aria-controls="callout-34" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-34" class="callout-34-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>traj_df <span class="ot">&lt;-</span> <span class="fu">read_trajectory</span>(path)</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>traj_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,604 × 4
    time pop      freq onset
   &lt;dbl&gt; &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt;
 1 11990 EHG    0      12000
 2 11990 ANA    0      12000
 3 11990 EUR    0.0001 12000
 4 11990 YAM   NA      12000
 5 11960 EHG    0      12000
 6 11960 ANA    0      12000
 7 11960 EUR    0.0001 12000
 8 11960 YAM   NA      12000
 9 11930 EHG    0      12000
10 11930 ANA    0      12000
# ℹ 1,594 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_trajectory</span>(traj_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 554 rows containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparing the trajectories side-by-side with the demographic model reveals</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="co"># some obvious patterns of both selection and demographic history.</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_model</span>(model),</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_trajectory</span>(traj_df),</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">rel_widths =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="dv">1</span>)</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 554 rows containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-59-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that the beneficial allele which appeared in the European population was under <em>extremely strong selection</em> (look how its allele frequency shoots up immediately after its first appearance!). However, we can also se how the following demographic history with multiple admixture events kept “diluting” the allele frequency (indicated by the dips in the trajectory).</p>
<p>This is the kind of <em>slendr</em> simulation which could be also very useful for simulation-based inference, like we did in the previous exercise. Just imagine having a comparable aDNA time series data with empirical allele frequency trajectory over time and using it in an ABC setting!</p>
</div>
</div>
</div>
</section>
<section id="part-6-tajimas-d-genome-wide-and-window-based-from-the-selection-model" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="part-6-tajimas-d-genome-wide-and-window-based-from-the-selection-model"><span class="header-section-number">7.5</span> Part 6: Tajima’s D (genome-wide and window-based) from the selection model</h2>
<p>Recall that your simulation run saved results in the location stored in the <code>path</code> variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "slim.trees"     "trajectory.tsv"</code></pre>
</div>
</div>
<p>From this <code>path</code>, we’ve already successfuly investigated the frequency trajectories.</p>
<p>Now let’s compute Tajima’s D on the tree sequence simulated from our selection model. Hopefully we should see an interesting pattern in our selection scan? For instance, we don’t know yet <em>where</em> in the genome is the putative locus under selection!</p>
<p>To read a tree sequence simulated with <code>slim()</code> by our customized selection setup, we need to do a bit of work. To simplify things a bit, here’s the R code which makes it possible to do. Just copy it in your <code>exercise4.R</code> script as it is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's use my own saved simulation results, so that we're all on the</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="co"># same page going forward</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/selection"</span>)</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(path, <span class="st">"slim.trees"</span>) <span class="sc">%&gt;%</span>  <span class="co"># 1. compose full path to the slim.trees file</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts_read</span>(model) <span class="sc">%&gt;%</span>                 <span class="co"># 2. read the tree sequence file into R</span></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts_recapitate</span>(<span class="at">Ne =</span> <span class="dv">5000</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>) <span class="co"># 3. perform recapitation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Very briefly, because our tree sequence was generated by SLiM, it’s very likely that not all genealogies along the simulated genome will be fully coalesced (i.e., not all tree will have a single root). To explain why this is the case is out of the scope of this session, but read <a href="https://tskit.dev/pyslim/docs/latest/tutorial.html">here</a> if you’re interested in learning more. For the time being, it suffices to say that we can pass the (uncoalesced) tree sequence into the <code>ts_recapitate()</code> function, which then takes a SLiM tree sequence and simulates all necessary “ancestral history” that was missing on the uncoalesced trees, thus ensuring that the entire tree sequence is fully coalesced and can be correctly computed on.</p>
<p><strong>Now that you have a <code>ts</code> tree sequence object resulting from a new selection simulation run, repeat the analyses of genome-wide and window-based Tajima’s D from <em>Part 1</em> and <em>Part 2</em> of this exercise, again using the provided helper functions <code>process_tajima()</code> and <code>plot_tajima()</code>. Can you identify which locus has been the likely focal point of the positive selection? Which population shows evidence of selection? Which doesn’t and why (look again at the visualization of the demographic model above)?</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-35-contents" aria-controls="callout-35" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-35" class="callout-35-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">ts_names</span>(ts, <span class="at">split =</span> <span class="st">"pop"</span>)</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$ANA
 [1] "ANA_1"  "ANA_2"  "ANA_3"  "ANA_4"  "ANA_5"  "ANA_6"  "ANA_7"  "ANA_8" 
 [9] "ANA_9"  "ANA_10" "ANA_11" "ANA_12" "ANA_13" "ANA_14" "ANA_15" "ANA_16"
[17] "ANA_17" "ANA_18" "ANA_19" "ANA_20" "ANA_21" "ANA_22" "ANA_23" "ANA_24"
[25] "ANA_25" "ANA_26" "ANA_27" "ANA_28" "ANA_29" "ANA_30" "ANA_31" "ANA_32"
[33] "ANA_33" "ANA_34" "ANA_35" "ANA_36" "ANA_37" "ANA_38" "ANA_39" "ANA_40"
[41] "ANA_41" "ANA_42" "ANA_43" "ANA_44" "ANA_45" "ANA_46" "ANA_47" "ANA_48"
[49] "ANA_49" "ANA_50"

$EHG
 [1] "EHG_1"  "EHG_2"  "EHG_3"  "EHG_4"  "EHG_5"  "EHG_6"  "EHG_7"  "EHG_8" 
 [9] "EHG_9"  "EHG_10" "EHG_11" "EHG_12" "EHG_13" "EHG_14" "EHG_15" "EHG_16"
[17] "EHG_17" "EHG_18" "EHG_19" "EHG_20" "EHG_21" "EHG_22" "EHG_23" "EHG_24"
[25] "EHG_25" "EHG_26" "EHG_27" "EHG_28" "EHG_29" "EHG_30" "EHG_31" "EHG_32"
[33] "EHG_33" "EHG_34" "EHG_35" "EHG_36" "EHG_37" "EHG_38" "EHG_39" "EHG_40"
[41] "EHG_41" "EHG_42" "EHG_43" "EHG_44" "EHG_45" "EHG_46" "EHG_47" "EHG_48"
[49] "EHG_49" "EHG_50"

$EUR
 [1] "EUR_1"  "EUR_2"  "EUR_3"  "EUR_4"  "EUR_5"  "EUR_6"  "EUR_7"  "EUR_8" 
 [9] "EUR_9"  "EUR_10" "EUR_11" "EUR_12" "EUR_13" "EUR_14" "EUR_15" "EUR_16"
[17] "EUR_17" "EUR_18" "EUR_19" "EUR_20" "EUR_21" "EUR_22" "EUR_23" "EUR_24"
[25] "EUR_25" "EUR_26" "EUR_27" "EUR_28" "EUR_29" "EUR_30" "EUR_31" "EUR_32"
[33] "EUR_33" "EUR_34" "EUR_35" "EUR_36" "EUR_37" "EUR_38" "EUR_39" "EUR_40"
[41] "EUR_41" "EUR_42" "EUR_43" "EUR_44" "EUR_45" "EUR_46" "EUR_47" "EUR_48"
[49] "EUR_49" "EUR_50"

$YAM
 [1] "YAM_1"  "YAM_2"  "YAM_3"  "YAM_4"  "YAM_5"  "YAM_6"  "YAM_7"  "YAM_8" 
 [9] "YAM_9"  "YAM_10" "YAM_11" "YAM_12" "YAM_13" "YAM_14" "YAM_15" "YAM_16"
[17] "YAM_17" "YAM_18" "YAM_19" "YAM_20" "YAM_21" "YAM_22" "YAM_23" "YAM_24"
[25] "YAM_25" "YAM_26" "YAM_27" "YAM_28" "YAM_29" "YAM_30" "YAM_31" "YAM_32"
[33] "YAM_33" "YAM_34" "YAM_35" "YAM_36" "YAM_37" "YAM_38" "YAM_39" "YAM_40"
[41] "YAM_41" "YAM_42" "YAM_43" "YAM_44" "YAM_45" "YAM_46" "YAM_47" "YAM_48"
[49] "YAM_49" "YAM_50"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall Tajima's D across the 10Mb sequence still doesn't reveal any significant</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="co"># deviations even in case of selection (again, not entirely unsurprising)</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_tajima</span>(ts, <span class="at">sample_sets =</span> samples, <span class="at">mode =</span> <span class="st">"branch"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  set          D
  &lt;chr&gt;    &lt;dbl&gt;
1 ANA   -0.00757
2 EHG    0.0273 
3 EUR   -0.360  
4 YAM   -0.377  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co"># So let's look at the window-based computation again...</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>windows <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">seq</span>(<span class="dv">0</span>, ts<span class="sc">$</span>sequence_length, <span class="at">length.out =</span> <span class="dv">100</span>))</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a><span class="co"># compute genome-wide Tajima's D for each population in individual windows</span></span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>tajima_wins <span class="ot">&lt;-</span> <span class="fu">ts_tajima</span>(ts, <span class="at">sample_sets =</span> samples, <span class="at">windows =</span> windows, <span class="at">mode =</span> <span class="st">"branch"</span>)</span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>tajima_df <span class="ot">&lt;-</span> <span class="fu">process_tajima</span>(tajima_wins)</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_tajima</span>(tajima_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You should see a clear dip in Tajima’s D around the midpoint of the DNA sequence, but only in Europeans. The beneficial allele appeared in the European population, and although the plot of the allele frequency trajectories shows that the selection dynamics has been <em>dramatically</em> affected by gene-flow events (generally causing a repeated “dilution” of the selection signal in Europeans), there has never been gene-flow (at least in our model) <em>from</em> Europeans to other populations, so the beneficial allele never had a chance to “make it” into those populations.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-39-contents" aria-controls="callout-39" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bonus exercises
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-39" class="callout-39-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="bonus-1-investigate-the-impact-of-recombination-around-the-selected-locus" class="level4" data-number="7.5.0.1">
<h4 data-number="7.5.0.1" class="anchored" data-anchor-id="bonus-1-investigate-the-impact-of-recombination-around-the-selected-locus"><span class="header-section-number">7.5.0.1</span> Bonus 1: Investigate the impact of recombination around the selected locus</h4>
<p>Vary the uniform recombination rate and observe what happens with Tajima’s D in windows along the genome.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-36-contents" aria-controls="callout-36" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-36" class="callout-36-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Solution: just modify the value of the <code>recombination_rate =</code> argument provided to the <code>slim()</code> function above.</p>
</div>
</div>
</div>
</section>
<section id="bonus-2-simulate-origin-of-the-allele-in-ehg" class="level4" data-number="7.5.0.2">
<h4 data-number="7.5.0.2" class="anchored" data-anchor-id="bonus-2-simulate-origin-of-the-allele-in-ehg"><span class="header-section-number">7.5.0.2</span> Bonus 2: Simulate origin of the allele in EHG</h4>
<p>Simulate the origin of the beneficial allele in the EHG population – what do the trajectories look like now? How does that change the Tajima’s D distribution along the genome in our European populations?</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-37-contents" aria-controls="callout-37" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-37" class="callout-37-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Use this extension in the <code>slim()</code> call, and repeat the rest of the selection-based workflow in this exercise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>extension <span class="ot">&lt;-</span> <span class="fu">substitute_values</span>(</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">template =</span> <span class="st">"slim_extension.txt"</span>,</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">origin_pop =</span> <span class="st">"EHG"</span>,</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">s =</span> <span class="fl">0.1</span>,</span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">onset_time =</span> <span class="dv">12000</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">compile_model</span>(</span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">populations =</span> <span class="fu">list</span>(afr, ooa, ehg, eur, ana, yam),</span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">gene_flow =</span> gf, <span class="at">generation_time =</span> <span class="dv">30</span>,</span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">extension =</span> extension</span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="bonus-3-other-statistics-in-windows" class="level4" data-number="7.5.0.3">
<h4 data-number="7.5.0.3" class="anchored" data-anchor-id="bonus-3-other-statistics-in-windows"><span class="header-section-number">7.5.0.3</span> Bonus 3: Other statistics in windows</h4>
<p>As a practice of your newly acquired tree-sequence computation skills with <em>slendr</em>, calculate some other statistics in the same windows along the simulated genome, visualize them yourself, and compare the results to the window-based Tajima’s D pattern. For instance, <code>ts_diversity()</code>, <code>ts_divergence()</code>, or <code>ts_segregating()</code> might be quite interesting to look at.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-38-contents" aria-controls="callout-38" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-38" class="callout-38-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Use the same tree sequence file you’ve computed Tajima’s D on, and then apply the functions <code>ts_diversity()</code>, <code>ts_divergence()</code>, and <code>ts_segregating()</code> on that tree sequence.</p>
</div>
</div>
</div>
</section>
</div>
</div>
</div>
<!-- End of Bonus exercises -->
<hr>
</section>
</section>
<section id="playing-around-with-pca-patterns" class="level1 page-columns page-full" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Playing around with PCA patterns</h1>
<p><strong>Note:</strong> We’re unlikely to make it to this part, so this is extra bonus which can be ignored!</p>
<p>In earlier lectures you’ve learned about the <a href="https://en.wikipedia.org/wiki/Principal_component_analysis">Principal Component Analysis</a>, a dimensional-reduction technique that’s a central piece of many (if not most) papers studying population history of many (hundreds) of individuals genotyped across many (millions) SNPs.</p>
<p>Although incredibly popular, PCA has recently been a topic of controversy, with a <a href="https://www.nature.com/articles/s41598-022-14395-4">highly combative</a> paper criticizing the application of PCA in all of population genetics, almost to a point of claiming that none of the results can be published. As an example, take a look at <a href="https://www.nature.com/articles/s41598-022-14395-4#Fig5">Figure 5</a> in the paper, demonstrating that an Indian population can be arbitrarily placed in proximity to Europeans, East Asians, and Africans, simply by wiggling the sample sizes of all groups before they applying PCA on their genotype data.</p>
<p>This activity session is not a place to debate the merit of PCA (or any other popgen method for that matter). What we can do (as we’ve done in previous exercises) is to show how <em>slendr</em> can be used in a very easy way to evaluate patterns, expected behavior, and overall dynamics of many popgen metrics in a controlled settings – and in this way, verify our intuition and check the robustness of a method in question – using PCA as another example. We’ll be specifically looking at patterns which arise in PCA depending on the exact spatio-temporal sampling from a demographic model.</p>
<section id="part-1-create-a-model" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="part-1-create-a-model"><span class="header-section-number">8.1</span> Part 1: Create a model</h2>
<p><strong>Start a new script named <code>exercise5.R</code> with the following setup of another toy demographic model:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slendr)</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="fu">init_env</span>(<span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"utils.R"</span>))</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>popA <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"popA"</span>, <span class="at">time =</span> <span class="dv">3000</span>, <span class="at">N =</span> <span class="dv">5000</span>)</span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>popB <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"popB"</span>, <span class="at">time =</span> <span class="dv">1500</span>, <span class="at">N =</span> <span class="dv">5000</span>, <span class="at">parent =</span> popA)</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>popC <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"popC"</span>, <span class="at">time =</span> <span class="dv">1500</span>, <span class="at">N =</span> <span class="dv">5000</span>, <span class="at">parent =</span> popA)</span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">compile_model</span>(<span class="fu">list</span>(popA, popB, popC), <span class="at">generation_time =</span> <span class="dv">1</span>)</span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>schedule <span class="ot">&lt;-</span> <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="fu">seq</span>(<span class="dv">3000</span>, <span class="dv">0</span>, <span class="at">by =</span> <span class="sc">-</span><span class="dv">200</span>),</span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">list</span>(popA, <span class="dv">10</span>), <span class="fu">list</span>(popB, <span class="dv">10</span>), <span class="fu">list</span>(popC, <span class="dv">10</span>))</span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model, <span class="at">proportions =</span> <span class="cn">TRUE</span>, <span class="at">samples =</span> schedule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As you can see, this model describes the demographic history of three populations: one ancestral population “popA” starting at 3000 generations ago, which splits into two populations “popB” and “popC” the same time at 1500 generations ago. We den instruct <em>slendr</em> to record 10 individuals from each of the three populations starting from 3000 generations ago all the way to 0 generations ago (i.e. the “present”), every 200 generations (remeber the <code>seq()</code> R function!).</p>
</section>
<section id="part-2-simulate-a-mutated-tree-sequence" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="part-2-simulate-a-mutated-tree-sequence"><span class="header-section-number">8.2</span> Part 2: Simulate a (mutated!) tree sequence</h2>
<p>To be able to run PCA using the <a href="https://christianhuber.github.io/smartsnp/"><em>smartsnp</em> R package</a> (below), we will need to simulate data in the <a href="https://bodkan.net/admixr/articles/01-tutorial.html#a-note-about-eigenstrat-format">EIGENSTRAT</a> file format. And to do <em>that</em>, we need our tree sequence with mutations.</p>
<p>Recall that all of our previous exercises managed to do away with mutations completely, owing to the amazing nature of the succint tree sequence data structure invented by the people behind the <em>tskit</em> project. However, all traditional popgen software and tools still rely on genotype data, which is why we now have to simulate mutations as well. Luckily, this is very easy – instead of the traditional</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> ..., <span class="at">recombination_rate =</span> ..., <span class="at">samples =</span> ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>we will run this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First run a normal msprime simulation creating a tree-sequence object, then</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="co"># directly pipe it into a function which adds (neutral!) mutations to it</span></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> ..., <span class="at">recombination_rate =</span> ..., <span class="at">samples =</span> ...) <span class="sc">%&gt;%</span></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts_mutate</span>(<span class="at">mutation_rate =</span> ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which is equivalent to running this without the <code>%&gt;%</code> “pipe operator”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First run a normal msprime simulation creating a tree-sequence object...</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>ts_nomuts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">sequence_length =</span> ..., <span class="at">recombination_rate =</span> ..., <span class="at">samples =</span> ...)</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ... then add (neutral!) mutations to it</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">ts_mutate</span>(ts_nomuts, <span class="at">mutation_rate =</span> ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With that out of the way, <strong>simulate a tree sequence from the popA/popB/popC <code>model</code> above, which will be 50 Mb (50e6) long, with a recombination rate 1e-8, and overlay mutations on it at a rate 1e-8. Check that it has mutations either by typing out <code>ts</code> in the console and looking for a “Mutations” section of the summary, or by using the function <code>ts_table(ts, "mutations")</code>. Then count how many individuals you have recorded for each population using the table produced by <code>ts_samples()</code>.</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-40-contents" aria-controls="callout-40" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-40" class="callout-40-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First run a normal msprime simulation creating a tree-sequence object, then</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="co"># directly pipe it into a function which adds (neutral!) mutations to it</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>ts_nomuts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">samples =</span> schedule, <span class="at">sequence_length =</span> <span class="fl">50e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>, <span class="at">random_seed =</span> <span class="dv">1702182272</span>)</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Notice we have no mutations on the tree sequence, just as before...</span></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>ts_nomuts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>╔═══════════════════════════╗
║TreeSequence               ║
╠═══════════════╤═══════════╣
║Trees          │     160114║
╟───────────────┼───────────╢
║Sequence Length│   50000000║
╟───────────────┼───────────╢
║Time Units     │generations║
╟───────────────┼───────────╢
║Sample Nodes   │        620║
╟───────────────┼───────────╢
║Total Size     │   26.1 MiB║
╚═══════════════╧═══════════╝
╔═══════════╤══════╤═════════╤════════════╗
║Table      │Rows  │Size     │Has Metadata║
╠═══════════╪══════╪═════════╪════════════╣
║Edges      │619886│ 18.9 MiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Individuals│   310│  8.5 KiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Migrations │     0│  8 Bytes│          No║
╟───────────┼──────┼─────────┼────────────╢
║Mutations  │     0│ 16 Bytes│          No║
╟───────────┼──────┼─────────┼────────────╢
║Nodes      │ 92209│  2.5 MiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Populations│     3│303 Bytes│         Yes║
╟───────────┼──────┼─────────┼────────────╢
║Provenances│     1│  5.2 KiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Sites      │     0│ 16 Bytes│          No║
╚═══════════╧══════╧═════════╧════════════╝</code></pre>
</div>
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">ts_mutate</span>(ts_nomuts, <span class="at">mutation_rate =</span> <span class="fl">1e-8</span>)</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ... but we have them now!</span></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>ts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>╔═══════════════════════════╗
║TreeSequence               ║
╠═══════════════╤═══════════╣
║Trees          │     160114║
╟───────────────┼───────────╢
║Sequence Length│   50000000║
╟───────────────┼───────────╢
║Time Units     │generations║
╟───────────────┼───────────╢
║Sample Nodes   │        620║
╟───────────────┼───────────╢
║Total Size     │   36.1 MiB║
╚═══════════════╧═══════════╝
╔═══════════╤══════╤═════════╤════════════╗
║Table      │Rows  │Size     │Has Metadata║
╠═══════════╪══════╪═════════╪════════════╣
║Edges      │619886│ 18.9 MiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Individuals│   310│  8.5 KiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Migrations │     0│  8 Bytes│          No║
╟───────────┼──────┼─────────┼────────────╢
║Mutations  │168780│  6.0 MiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Nodes      │ 92209│  2.5 MiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Populations│     3│303 Bytes│         Yes║
╟───────────┼──────┼─────────┼────────────╢
║Provenances│     2│  6.0 KiB│          No║
╟───────────┼──────┼─────────┼────────────╢
║Sites      │168492│  4.0 MiB│          No║
╚═══════════╧══════╧═════════╧════════════╝</code></pre>
</div>
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the table of individuals (and process it a bit for tidier plotting later)</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">ts_samples</span>(ts) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">pop =</span> <span class="fu">factor</span>(pop, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"popA"</span>, <span class="st">"popB"</span>, <span class="st">"popC"</span>)))</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Count how many individuals do we have for each population</span></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>samples <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(pop) <span class="sc">%&gt;%</span> <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
# Groups:   pop [3]
  pop       n
  &lt;fct&gt; &lt;int&gt;
1 popA    150
2 popB     80
3 popC     80</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="part-3-converting-a-tree-sequence-into-eigenstrat" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="part-3-converting-a-tree-sequence-into-eigenstrat"><span class="header-section-number">8.3</span> Part 3: Converting a tree sequence into EIGENSTRAT</h2>
<p>The function to use for converting a tree-sequence object we have in R (in our exercises the thing we usually had in the <code>ts</code> variable) to disk in form of genotypes in the EIGENSTRAT format is called <code>ts_eigenstrat()</code>. The standard way to call it (but see <code>?ts_eigenstrat</code> for more options) is like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_eigenstrat</span>(ts, <span class="at">prefix =</span> <span class="st">"path/to/a/desired/EIGENSTRAT/prefix"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which creates three files <code>.ind</code>, <code>.snp</code>, and <code>.geno</code> as: - <code>path/to/a/desired/EIGENSTRAT/prefix.ind</code>, - <code>path/to/a/desired/EIGENSTRAT/prefix.snp</code>, and - <code>path/to/a/desired/EIGENSTRAT/prefix.geno</code>,</p>
<p>just as you would expect for any EIGENSTRAT file.</p>
<p><strong>Take your tree sequence <code>ts</code> just just simulated, and convert it to EIGENSTRAT format under the prefix <code>data/ABC_all</code>.</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-41-contents" aria-controls="callout-41" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-41" class="callout-41-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_eigenstrat</span>(ts, <span class="st">"data/ABC_all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>182 multiallelic sites (0.108% out of 168492 total) detected and removed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>EIGENSTRAT object
=================
components:
  ind file: data/ABC_all.ind
  snp file: data/ABC_all.snp
  geno file: data/ABC_all.geno</code></pre>
</div>
</div>
</div>
</div>
</div>
<p><strong>Check that the EIGENSTRAT files really appeared at the path that you specified (in the terminal).</strong></p>
</section>
<section id="part-4-inspect-the-eigenstrat-data-produced-by-slendr" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="part-4-inspect-the-eigenstrat-data-produced-by-slendr"><span class="header-section-number">8.4</span> Part 4: Inspect the EIGENSTRAT data produced by <em>slendr</em></h2>
<p>Years ago I developed a small R package to help me with <span class="math inline">\(f\)</span>-statistics based projects using the ADMIXTOOLS software (which operates on data in the EIGENSTRAT file format), called <a href="https://bodkan.net/admixr/">admixr</a></p>
<p><strong>Use the following code to examine one of the EIGENSTRAT data sets you’ve just created. Just look at the results and see if they make sense in terms of what you’ve learned about this in earlier lectures.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(admixr)</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>eigen <span class="ot">&lt;-</span> <span class="fu">eigenstrat</span>(<span class="st">"&lt;prefix of a trio of EIGENSTRAT .ind/.snp/.geno files"</span>)</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out a summary of the EIGENSTRAT data</span></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a>eigen</span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the .ind file as a table into R</span></span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a><span class="fu">read_ind</span>(eigen)</span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the .snp file as a table into R</span></span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a><span class="fu">read_snp</span>(eigen)</span>
<span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the .geno file as a table into R</span></span>
<span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a><span class="fu">read_geno</span>(eigen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-42-contents" aria-controls="callout-42" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-42" class="callout-42-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(admixr)</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>eigen <span class="ot">&lt;-</span> <span class="fu">eigenstrat</span>(<span class="st">"data/ABC_all"</span>)</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out a summary of the EIGENSTRAT data</span></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>eigen</span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the .ind file as a table into R</span></span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a><span class="fu">read_ind</span>(eigen)</span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the .snp file as a table into R</span></span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a><span class="fu">read_snp</span>(eigen)</span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the .geno file as a table into R</span></span>
<span id="cb212-13"><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a><span class="fu">read_geno</span>(eigen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="part-5-principal-component-analysis-on-the-entire-simulated-data-set" class="level2 page-columns page-full" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="part-5-principal-component-analysis-on-the-entire-simulated-data-set"><span class="header-section-number">8.5</span> Part 5: Principal Component Analysis on the entire simulated data set</h2>
<p>Now, at long last, we have everything we need to be able to run ABC on the data generated by our <em>slendr</em> model. To avoid making this exercise even longer, I provided a helper function for you called <code>plot_pca()</code>. But this function isn’t doing anything magical – it uses the <a href="https://christianhuber.github.io/smartsnp/"><em>smartsnp</em> R package</a> to compute the principal components and visualize the results using <em>ggplot2</em>. This is something many of you could do given enough time but we want to focus on simulations and PCA, not pure R coding. If you’re interested, take a look at my implementation of <code>plot_pca()</code> <a href="https://github.com/bodkan/simgen/blob/main/utils.R#L15">here</a>.</p>
<p>Here’s how you can use this function (remeber that you need to put <code>source(here::here("utils.R"))</code> into your script!):</p>
<ol type="1">
<li>Plot PCA while coloring each individual by their population assignment:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"path/to/prefix"</span>, <span class="sc">&lt;</span>tree sequence used to create EIGENSTRAT<span class="sc">&gt;</span>, <span class="at">color_by =</span> <span class="st">"pop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Plot PCA while coloring each individual by their time of sampling:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"path/to/prefix"</span>, <span class="sc">&lt;</span>tree sequence used to create EIGENSTRAT<span class="sc">&gt;</span>, <span class="at">color_by =</span> <span class="st">"time"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>By default, the function plots PC 1 vs PC 2, but you can customize things by providing an optional argument <code>pc =</code> like this:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"path/to/prefix"</span>, <span class="sc">&lt;</span>tree sequence used to create EIGENSTRAT<span class="sc">&gt;</span>, <span class="at">color_by =</span> <span class="st">"pop"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Use the provided <code>plot_pca()</code> function to run PCA based on genotypes for all recorded individuals that you just converted as EIGENSTRAT <code>"data/ABC_all"</code> from the <code>ts</code> tree sequence. Visualize PC 1 vs PC 2 by first ccolor each individual by their population label (<code>color_by = "pop"</code>) then by the time of their sampling (<code>color_by = "time"</code>).</strong></p>
<p><strong>Does the PCA of PC 1 vs PC 2 capture the relationship between all individuals across the populations <em>and across time</em>?</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-43-contents" aria-controls="callout-43" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-43" class="callout-43-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"pop"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was not found. Generating it now (this might take a moment)...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"time"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was found. Loading it to save computational time...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-77-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It looks like the PCA from PC 1 vs 2 cannot “partition out” the drift along the ancestral “popA” lineage prior to the population splits!</p>
</div>
</div>
</div>
<p><strong>Use <code>plot_pca()</code> to compute the PCAon this exact same data, but examine how does the shape of the PCA scatterplot change when you switch the pairs of PCs plotted (i.e., PC 2 vs PC 3, PC 3 vs PC 4, PC 4 vs PC 6, etc.). Which pair of PCs does the best job at recapitulating the demographic model?</strong></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><strong>Note:</strong> We’re doing this purely for educational purposes and for fun, using an extremely idealistic demographic model which is perfectly known (by definition, because we simulated it) and perfect sampling scheme. The point is to explore what does doing a PCA mean in practice, visually, and to built intuition into it.</p>
</div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-44-contents" aria-controls="callout-44" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-44" class="callout-44-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  We can see that the overall shape of the demographic model tree is now nicely</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="co"># reflected in the PCA shape</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"pop"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was found. Loading it to save computational time...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-78-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"time"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was found. Loading it to save computational time...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-78-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"pop"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was found. Loading it to save computational time...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-78-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"time"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was found. Loading it to save computational time...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-78-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Things are getting progressively wilder! </span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"pop"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was found. Loading it to save computational time...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-78-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"time"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was found. Loading it to save computational time...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-78-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"pop"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was found. Loading it to save computational time...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-78-7.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/ABC_all"</span>, ts, <span class="at">color_by =</span> <span class="st">"time"</span>, <span class="at">pc =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was found. Loading it to save computational time...</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-78-8.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-46-contents" aria-controls="callout-46" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bonus exercises
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-46" class="callout-46-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="bonus-1-tree-sequence-simplification-and-eigenstrat-conversion" class="level3" data-number="8.5.1">
<h3 data-number="8.5.1" class="anchored" data-anchor-id="bonus-1-tree-sequence-simplification-and-eigenstrat-conversion"><span class="header-section-number">8.5.1</span> Bonus 1: Tree-sequence simplification and EIGENSTRAT conversion</h3>
<p>One of our goals in this exercise was to investigate how does the shape of a PCA look like based on the sampling of individuals across populations and also across time – all of that from the <em>same</em> demographic history. In order to do that, we need to be able to select only a defined subset of individuals from a given tree sequence. Which brings us to the last tree-sequence processing function in <em>slendr</em> callsed <code>ts_simplify()</code>. Implemented on top of the <code>simplify()</code> method in <em>tskit</em>, it has a very simple interface:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>ts_small <span class="ot">&lt;-</span> <span class="fu">ts_simplify</span>(ts_big, <span class="at">simplify_to =</span> <span class="fu">c</span>(<span class="sc">&lt;</span>subset of individuals as a vector<span class="sc">&gt;</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function call creates a <em>new tree sequence</em>, which is smaller and only contains a those individuals whose names were specified in <code>simplify_to =</code> (again, we’re talking about the “symbolic names” of individuals, such as “NEA_1”, “AFR_42”, etc., not integer numbers of <em>tskit</em> nodes).</p>
<p>Whenever you want to create smaller subsets of a large tree sequence, it is often helpful to work with the table of all individuals in the original tree sequence, because it contains every individual’s <code>name</code>, <code>pop</code> assignment and the <code>time</code> in which it lived, so let’s save it for further use now:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">ts_samples</span>(ts)</span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 310</code></pre>
</div>
</div>
<p>For instance, we can get only individuals from “popB” and “popC” sampled at the present using this code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>subset <span class="ot">&lt;-</span> <span class="fu">filter</span>(samples, pop <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"popB"</span>, <span class="st">"popC"</span>), time <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(subset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20</code></pre>
</div>
</div>
<p>You know that the table of samples contains the <code>name</code> of each individual, which you can access as <code>subset$name</code>. <strong>Use the <code>ts_simplify()</code> function to create a new tree sequence called <code>ts_BC0</code> which contains only this subset of individuals. Check that it really does contain only the defined subset of individuals using <code>ts_samples(ts_BC0)</code>.</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-45-contents" aria-controls="callout-45" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click to see the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-45" class="callout-45-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>ts_BC0 <span class="ot">&lt;-</span> <span class="fu">ts_simplify</span>(ts, <span class="at">simplify_to =</span> subset<span class="sc">$</span>name)</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts_BC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 3
   name     time pop  
   &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;
 1 popB_71     0 popB 
 2 popB_72     0 popB 
 3 popB_73     0 popB 
 4 popB_74     0 popB 
 5 popB_75     0 popB 
 6 popB_76     0 popB 
 7 popB_77     0 popB 
 8 popB_78     0 popB 
 9 popB_79     0 popB 
10 popB_80     0 popB 
11 popC_71     0 popC 
12 popC_72     0 popC 
13 popC_73     0 popC 
14 popC_74     0 popC 
15 popC_75     0 popC 
16 popC_76     0 popC 
17 popC_77     0 popC 
18 popC_78     0 popC 
19 popC_79     0 popC 
20 popC_80     0 popC </code></pre>
</div>
</div>
</div>
</div>
</div>
<p>When you have a smaller tree sequence like this, you can convert it to an EIGENSTRAT file format using <code>ts_eigenstrat()</code> just like we did above.</p>
</section>
<section id="part-2-pca-visualization-on-subsets-of-individuals" class="level3" data-number="8.5.2">
<h3 data-number="8.5.2" class="anchored" data-anchor-id="part-2-pca-visualization-on-subsets-of-individuals"><span class="header-section-number">8.5.2</span> Part 2: PCA visualization on subsets of individuals</h3>
<p><strong>TODO</strong>: Try to replicate some features of <a href="https://www.nature.com/articles/s41598-022-14395-4#Fig5">the results</a> discovered for EUR/ASIAN/AFR/Indian populations.</p>
</section>
</div>
</div>
</div>
<!-- End of Bonus exercises -->
</section>
</section>
<section id="spatial-pca" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Spatial PCA</h1>
<p><strong>WIP:</strong> Exploring how (and when) PCA patterns recapitulate geographical history of populations, inspired by this figure by Novembre <em>et al.</em> (2008).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/novembre2008a.jpg" class="img-fluid figure-img"></p>
<figcaption>Novembre et al., 2008</figcaption>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slendr)</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a><span class="fu">init_env</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The interface to all required Python modules has been activated.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(admixr)</span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utils.R"</span>)</span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-6"><a href="#cb245-6" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">landscape_model</span>(<span class="at">rate =</span> <span class="fl">0.3</span>, <span class="at">Ne =</span> <span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `ne_110m_land' from data source 
  `/private/var/folders/70/b_q2zdh116b9pfg29p03sx600000gn/T/RtmpWLi9I5/naturalearth/ne_110m_land.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 127 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pdf("exercise5.pdf", width = 8, height = 5)</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for (n in c(50, 25, 10, 5, 2, 1)) {</span></span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>  schedule <span class="ot">&lt;-</span> <span class="fu">landscape_sampling</span>(model, n)</span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a>  ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">samples =</span> schedule, <span class="at">sequence_length =</span> <span class="fl">20e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>) <span class="sc">%&gt;%</span> <span class="fu">ts_mutate</span>(<span class="fl">1e-8</span>)</span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-8"><a href="#cb247-8" aria-hidden="true" tabindex="-1"></a>  samples <span class="ot">&lt;-</span> <span class="fu">ts_samples</span>(ts)</span>
<span id="cb247-9"><a href="#cb247-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-10"><a href="#cb247-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts_eigenstrat</span>(ts, <span class="st">"data/spatial_pca1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>412 multiallelic sites (0.255% out of 161512 total) detected and removed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>EIGENSTRAT object
=================
components:
  ind file: data/spatial_pca1.ind
  snp file: data/spatial_pca1.snp
  geno file: data/spatial_pca1.geno</code></pre>
</div>
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_pca</span>(<span class="st">"data/spatial_pca1"</span>, ts, <span class="at">model =</span> <span class="st">"map"</span>, <span class="at">color_by =</span> <span class="st">"pop"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was not found. Generating it now (this might take a moment)...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: All gene-flow event will be visualized at once. If you wish to visualize
gene flows at a particular point in time, use the `time` argument.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-spatial populations in your model won't be visualized</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-83-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="per-population-ne-values" class="level3" data-number="9.0.1">
<h3 data-number="9.0.1" class="anchored" data-anchor-id="per-population-ne-values"><span class="header-section-number">9.0.1</span> Per-population Ne values</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slendr)</span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a><span class="fu">init_env</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The interface to all required Python modules has been activated.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(admixr)</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utils.R"</span>)</span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>Ne <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1 =</span> <span class="dv">10000</span>,</span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">p2 =</span> <span class="dv">10000</span>,</span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">p3 =</span> <span class="dv">10000</span>,</span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">p4 =</span> <span class="dv">10000</span>,</span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">p5 =</span> <span class="dv">100</span>,</span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">p6 =</span> <span class="dv">10000</span>,</span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">p7 =</span> <span class="dv">10000</span>,</span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">p8 =</span> <span class="dv">10000</span>,</span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">p9 =</span> <span class="dv">10000</span>,</span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">p10 =</span> <span class="dv">10000</span></span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb257-18"><a href="#cb257-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-19"><a href="#cb257-19" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">landscape_model</span>(<span class="at">rate =</span> <span class="fl">0.3</span>, <span class="at">Ne =</span> Ne)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `ne_110m_land' from data source 
  `/private/var/folders/70/b_q2zdh116b9pfg29p03sx600000gn/T/RtmpWLi9I5/naturalearth/ne_110m_land.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 127 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1 =</span> <span class="dv">50</span>,</span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">p2 =</span> <span class="dv">50</span>,</span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">p3 =</span> <span class="dv">50</span>,</span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">p4 =</span> <span class="dv">50</span>,</span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">p5 =</span> <span class="dv">5</span>,</span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">p6 =</span> <span class="dv">50</span>,</span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">p7 =</span> <span class="dv">50</span>,</span>
<span id="cb259-9"><a href="#cb259-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">p8 =</span> <span class="dv">50</span>,</span>
<span id="cb259-10"><a href="#cb259-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">p9 =</span> <span class="dv">50</span>,</span>
<span id="cb259-11"><a href="#cb259-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">p10 =</span> <span class="dv">50</span></span>
<span id="cb259-12"><a href="#cb259-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb259-13"><a href="#cb259-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-14"><a href="#cb259-14" aria-hidden="true" tabindex="-1"></a>schedule <span class="ot">&lt;-</span> <span class="fu">landscape_sampling</span>(model, n)</span>
<span id="cb259-15"><a href="#cb259-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-16"><a href="#cb259-16" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">samples =</span> schedule, <span class="at">sequence_length =</span> <span class="fl">20e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>) <span class="sc">%&gt;%</span> <span class="fu">ts_mutate</span>(<span class="fl">1e-8</span>)</span>
<span id="cb259-17"><a href="#cb259-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-18"><a href="#cb259-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_eigenstrat</span>(ts, <span class="st">"data/spatial_pca2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>1090 multiallelic sites (0.432% out of 252070 total) detected and removed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>EIGENSTRAT object
=================
components:
  ind file: data/spatial_pca2.ind
  snp file: data/spatial_pca2.snp
  geno file: data/spatial_pca2.geno</code></pre>
</div>
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_ind</span>(<span class="fu">eigenstrat</span>(<span class="st">"data/spatial_pca2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 455 × 3
   id    sex   label
   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
 1 p1_1  U     p1_1 
 2 p1_2  U     p1_2 
 3 p1_3  U     p1_3 
 4 p1_4  U     p1_4 
 5 p1_5  U     p1_5 
 6 p1_6  U     p1_6 
 7 p1_7  U     p1_7 
 8 p1_8  U     p1_8 
 9 p1_9  U     p1_9 
10 p1_10 U     p1_10
# ℹ 445 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ts_samples</span>(ts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 455 × 3
   name   time pop  
   &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;
 1 p1_1  10000 p1   
 2 p1_2  10000 p1   
 3 p1_3  10000 p1   
 4 p1_4  10000 p1   
 5 p1_5  10000 p1   
 6 p1_6  10000 p1   
 7 p1_7  10000 p1   
 8 p1_8  10000 p1   
 9 p1_9  10000 p1   
10 p1_10 10000 p1   
# ℹ 445 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(<span class="st">"data/spatial_pca2"</span>, ts, <span class="at">model =</span> <span class="st">"map"</span>, <span class="at">color =</span> <span class="st">"pop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PCA cache for the given EIGENSTRAT data was not found. Generating it now (this might take a moment)...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: All gene-flow event will be visualized at once. If you wish to visualize
gene flows at a particular point in time, use the `time` argument.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-spatial populations in your model won't be visualized</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-84-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="ancestry-tracts-and-chromosome-painintg" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Ancestry tracts and chromosome painintg</h1>
<p><strong>WIP:</strong> Extracting ancestry tracts, chromosome painting, and using admixture tracts and LD patterns for dating admixture events.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slendr)</span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a><span class="fu">init_env</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The interface to all required Python modules has been activated.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utils.R"</span>)</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-5"><a href="#cb272-5" aria-hidden="true" tabindex="-1"></a>popZ <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"popZ"</span>, <span class="at">time =</span> <span class="dv">3000</span>, <span class="at">N =</span> <span class="dv">5000</span>)</span>
<span id="cb272-6"><a href="#cb272-6" aria-hidden="true" tabindex="-1"></a>popX <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"popX"</span>, <span class="at">time =</span> <span class="dv">1500</span>, <span class="at">N =</span> <span class="dv">5000</span>, <span class="at">parent =</span> popZ)</span>
<span id="cb272-7"><a href="#cb272-7" aria-hidden="true" tabindex="-1"></a>popY <span class="ot">&lt;-</span> <span class="fu">population</span>(<span class="st">"popY"</span>, <span class="at">time =</span> <span class="dv">1500</span>, <span class="at">N =</span> <span class="dv">5000</span>, <span class="at">parent =</span> popZ)</span>
<span id="cb272-8"><a href="#cb272-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-9"><a href="#cb272-9" aria-hidden="true" tabindex="-1"></a>gf <span class="ot">&lt;-</span> <span class="fu">gene_flow</span>(<span class="at">from =</span> popX, <span class="at">to =</span> popY, <span class="at">rate =</span> <span class="fl">0.2</span>, <span class="at">start =</span> <span class="dv">800</span>, <span class="at">end =</span> <span class="dv">799</span>)</span>
<span id="cb272-10"><a href="#cb272-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-11"><a href="#cb272-11" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">compile_model</span>(<span class="fu">list</span>(popZ, popX, popY), <span class="at">generation_time =</span> <span class="dv">1</span>, <span class="at">gene_flow =</span> gf)</span>
<span id="cb272-12"><a href="#cb272-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-13"><a href="#cb272-13" aria-hidden="true" tabindex="-1"></a>schedule <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb272-14"><a href="#cb272-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="fu">seq</span>(<span class="dv">1500</span>, <span class="dv">0</span>, <span class="at">by =</span> <span class="sc">-</span><span class="dv">100</span>), <span class="fu">list</span>(popY, <span class="dv">50</span>)),</span>
<span id="cb272-15"><a href="#cb272-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">schedule_sampling</span>(model, <span class="at">times =</span> <span class="dv">0</span>, <span class="fu">list</span>(popX, <span class="dv">10</span>), <span class="fu">list</span>(popZ, <span class="dv">10</span>))</span>
<span id="cb272-16"><a href="#cb272-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb272-17"><a href="#cb272-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-18"><a href="#cb272-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the function plot_model() to make sure that the model and the sampling schedule</span></span>
<span id="cb272-19"><a href="#cb272-19" aria-hidden="true" tabindex="-1"></a><span class="co"># are defined correctly (there's no such thing as too many sanity checks when doing research)</span></span>
<span id="cb272-20"><a href="#cb272-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(model, <span class="at">proportions =</span> <span class="cn">TRUE</span>, <span class="at">samples =</span> schedule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-85-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">msprime</span>(model, <span class="at">samples =</span> schedule, <span class="at">sequence_length =</span> <span class="fl">100e6</span>, <span class="at">recombination_rate =</span> <span class="fl">1e-8</span>)</span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-7"><a href="#cb273-7" aria-hidden="true" tabindex="-1"></a>tracts <span class="ot">&lt;-</span> <span class="fu">ts_tracts</span>(ts, <span class="at">census =</span> <span class="dv">800</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
PopAncestry summary
Number of ancestral populations:    3
Number of sample chromosomes:       1540
Number of ancestors:            57497
Total length of genomes:        154000000000.000000
Ancestral coverage:             84000000000.000000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>tracts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47,634 × 10
# Groups:   name [400]
   name     haplotype  time pop   source_pop    left  right length source_pop_id
   &lt;chr&gt;        &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;fct&gt;        &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;         &lt;dbl&gt;
 1 popY_351         1   700 popY  popX        6.67e6 7.15e6 4.81e5             1
 2 popY_351         1   700 popY  popX        1.35e7 1.38e7 3.32e5             1
 3 popY_351         1   700 popY  popX        1.57e7 1.74e7 1.77e6             1
 4 popY_351         1   700 popY  popX        2.96e7 3.13e7 1.65e6             1
 5 popY_351         1   700 popY  popX        3.90e7 4.02e7 1.23e6             1
 6 popY_351         1   700 popY  popX        4.19e7 4.51e7 3.12e6             1
 7 popY_351         1   700 popY  popX        4.71e7 4.85e7 1.38e6             1
 8 popY_351         1   700 popY  popX        4.98e7 5.02e7 3.26e5             1
 9 popY_351         1   700 popY  popX        5.24e7 5.37e7 1.35e6             1
10 popY_351         1   700 popY  popX        5.66e7 5.71e7 5.21e5             1
# ℹ 47,624 more rows
# ℹ 1 more variable: node_id &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select sampled individuals from different ages (remember, we recorded oldest individuals</span></span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a><span class="co"># at 1000 generations ago, the youngest individuals at 0 generations ago). Use the function</span></span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_tracts to visualize their ancestry tracts. What do you see in terms of the number of</span></span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a><span class="co"># tracts and the length of tracts across these individuals? Can you eyeball some distinctive</span></span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a><span class="co"># pattern?</span></span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a>subset_inds <span class="ot">&lt;-</span> tracts <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(name) <span class="sc">%&gt;%</span> <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(name)</span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a>subset_inds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "popY_726" "popY_693" "popY_625" "popY_551" "popY_509" "popY_468" "popY_439"
[8] "popY_375"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_tracts</span>(tracts, subset_inds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-85-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="co"># It looks like the older individual is, the closer they lived to the start of the admixture event,</span></span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and the longer the tracts they carry will be. Compute the average length of a ancestry tracts in each</span></span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sample age group and visualize the length distribution of these tracts based on their age:</span></span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a>tracts <span class="sc">%&gt;%</span></span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">mean</span>(length))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
   time `mean(length)`
  &lt;dbl&gt;          &lt;dbl&gt;
1     0        160158.
2   100        175860.
3   200        205116.
4   300        245729.
5   400        298003.
6   500        385840.
7   600        592500.
8   700       1141799.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(tracts, <span class="fu">aes</span>(length, <span class="at">color =</span> <span class="fu">factor</span>(time))) <span class="sc">+</span></span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">3e6</span>)) <span class="sc">+</span></span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-85-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now, try to work backwards. Assuming you have the following distribution of tract lengths...</span></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>tracts <span class="ot">&lt;-</span> <span class="fu">filter</span>(tracts, time <span class="sc">==</span> <span class="dv">0</span>, length <span class="sc">&lt;=</span> <span class="fl">1e6</span>)</span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a>bins <span class="ot">&lt;-</span> <span class="fu">hist</span>(tracts<span class="sc">$</span>length, <span class="at">breaks =</span> <span class="dv">50</span>, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a>length <span class="ot">&lt;-</span> bins<span class="sc">$</span>mids</span>
<span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a>density <span class="ot">&lt;-</span> bins<span class="sc">$</span>density</span>
<span id="cb283-7"><a href="#cb283-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-8"><a href="#cb283-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(length, density)</span>
<span id="cb283-9"><a href="#cb283-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-10"><a href="#cb283-10" aria-hidden="true" tabindex="-1"></a>lambda_mle <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">mean</span>(tracts<span class="sc">$</span>length)</span>
<span id="cb283-11"><a href="#cb283-11" aria-hidden="true" tabindex="-1"></a>lambda_mle <span class="sc">/</span> <span class="fl">1e-8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 634.4843</code></pre>
</div>
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>y_mle <span class="ot">&lt;-</span> <span class="fu">dexp</span>(length, <span class="at">rate =</span> lambda_mle)</span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(length, y_mle, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"darkgreen"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-4"><a href="#cb285-4" aria-hidden="true" tabindex="-1"></a>nls_res <span class="ot">&lt;-</span> <span class="fu">nls</span>(density <span class="sc">~</span> <span class="fu">SSasymp</span>(length, Asym, R0, lrc))</span>
<span id="cb285-5"><a href="#cb285-5" aria-hidden="true" tabindex="-1"></a>nls_res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nonlinear regression model
  model: density ~ SSasymp(length, Asym, R0, lrc)
   data: parent.frame()
      Asym         R0        lrc 
 4.349e-09  6.344e-06 -1.197e+01 
 residual sum-of-squares: 5.454e-13

Number of iterations to convergence: 0 
Achieved convergence tolerance: 2.008e-06</code></pre>
</div>
<div class="sourceCode cell-code" id="cb287"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>lambda_nls <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">unname</span>(<span class="fu">coef</span>(nls_res)[<span class="st">"lrc"</span>]))</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>lambda_nls <span class="sc">/</span> <span class="fl">1e-8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 635.1988</code></pre>
</div>
<div class="sourceCode cell-code" id="cb289"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a>y_nls <span class="ot">&lt;-</span> <span class="fu">predict</span>(nls_res, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">length =</span> length))</span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(length, y_nls, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"purple"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"darkgreen"</span>, <span class="st">"purple"</span>),</span>
<span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MLE, t ="</span>, <span class="fu">round</span>(lambda_mle <span class="sc">/</span> <span class="fl">1e-8</span>, <span class="dv">1</span>), <span class="st">"generations ago"</span>),</span>
<span id="cb289-6"><a href="#cb289-6" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">paste</span>(<span class="st">"MLE, t ="</span>, <span class="fu">round</span>(lambda_nls <span class="sc">/</span> <span class="fl">1e-8</span>, <span class="dv">1</span>), <span class="st">"generations ago"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slendr_files/figure-html/unnamed-chunk-85-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./intro.html" class="pagination-link" aria-label="Introduction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>